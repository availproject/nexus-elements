{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "nexus-provider",
  "type": "registry:component",
  "title": "Nexus Provider",
  "description": "Shared Nexus SDK provider and types for Nexus Elements",
  "dependencies": [
    "@avail-project/nexus-core@1.0.0-rc.3"
  ],
  "files": [
    {
      "path": "registry/nexus-elements/nexus/NexusProvider.tsx",
      "content": "\"use client\";\nimport {\n  type EthereumProvider,\n  type NexusNetwork,\n  NexusSDK,\n  type OnAllowanceHookData,\n  type OnIntentHookData,\n  type SupportedChainsResult,\n  type UserAsset,\n  type OnSwapIntentHookData,\n  type SupportedChainsAndTokensResult,\n} from \"@avail-project/nexus-core\";\n\nimport {\n  createContext,\n  type RefObject,\n  useCallback,\n  useContext,\n  useMemo,\n  useRef,\n  useState,\n} from \"react\";\nimport { useAccountEffect } from \"wagmi\";\n\ninterface NexusContextType {\n  nexusSDK: NexusSDK | null;\n  unifiedBalance: UserAsset[] | null;\n  intent: RefObject<OnIntentHookData | null>;\n  allowance: RefObject<OnAllowanceHookData | null>;\n  swapIntent: RefObject<OnSwapIntentHookData | null>;\n  exchangeRate: Record<string, number> | null;\n  supportedChainsAndTokens: SupportedChainsAndTokensResult | null;\n  swapSupportedChainsAndTokens: SupportedChainsResult | null;\n  network?: NexusNetwork;\n  loading: boolean;\n  handleInit: (provider: EthereumProvider) => Promise<void>;\n  fetchUnifiedBalance: () => Promise<void>;\n  getFiatValue: (amount: number, token: string) => number;\n  initializeNexus: (provider: EthereumProvider) => Promise<void>;\n  deinitializeNexus: () => Promise<void>;\n  attachEventHooks: () => void;\n}\n\nconst NexusContext = createContext<NexusContextType | undefined>(undefined);\n\ntype NexusProviderProps = {\n  children: React.ReactNode;\n  config?: {\n    network?: NexusNetwork;\n    debug?: boolean;\n  };\n};\n\nconst NexusProvider = ({\n  children,\n  config = {\n    network: \"mainnet\",\n    debug: true,\n  },\n}: NexusProviderProps) => {\n  const sdk = useMemo(() => new NexusSDK(config), [config]);\n  const [nexusSDK, setNexusSDK] = useState<NexusSDK | null>(null);\n  const [loading, setLoading] = useState<boolean>(false);\n  const supportedChainsAndTokens =\n    useRef<SupportedChainsAndTokensResult | null>(null);\n  const swapSupportedChainsAndTokens = useRef<SupportedChainsResult | null>(\n    null\n  );\n  const unifiedBalance = useRef<UserAsset[] | null>(null);\n  const exchangeRate = useRef<Record<string, number> | null>(null);\n\n  const intent = useRef<OnIntentHookData | null>(null);\n  const allowance = useRef<OnAllowanceHookData | null>(null);\n  const swapIntent = useRef<OnSwapIntentHookData | null>(null);\n\n  const initChainsAndTokens = useCallback(() => {\n    const list = sdk?.utils?.getSupportedChains(\n      config?.network === \"testnet\" ? 0 : undefined\n    );\n    supportedChainsAndTokens.current = list ?? null;\n    const swapList = sdk?.utils?.getSwapSupportedChainsAndTokens();\n    swapSupportedChainsAndTokens.current = swapList ?? null;\n  }, [sdk, config?.network]);\n\n  const initializeNexus = async (provider: EthereumProvider) => {\n    setLoading(true);\n    try {\n      if (sdk.isInitialized()) throw new Error(\"Nexus is already initialized\");\n      await sdk.initialize(provider);\n      setNexusSDK(sdk);\n      initChainsAndTokens();\n      const [unifiedBalanceResult, rates] = await Promise.allSettled([\n        sdk?.getUnifiedBalances(true),\n        sdk?.utils?.getCoinbaseRates(),\n      ]);\n\n      if (unifiedBalanceResult.status === \"fulfilled\") {\n        unifiedBalance.current = unifiedBalanceResult.value;\n      }\n\n      if (rates?.status === \"fulfilled\") {\n        // Coinbase returns \"units per USD\" (e.g., 1 USD = 0.00028 ETH).\n        // Convert to \"USD per unit\" (e.g., 1 ETH = ~$3514) for straightforward UI calculations.\n\n        const usdPerUnit: Record<string, number> = {};\n\n        for (const [symbol, value] of Object.entries(rates ?? {})) {\n          const unitsPerUsd = Number.parseFloat(String(value));\n          if (Number.isFinite(unitsPerUsd) && unitsPerUsd > 0) {\n            usdPerUnit[symbol.toUpperCase()] = 1 / unitsPerUsd;\n          }\n        }\n\n        for (const token of [\"ETH\", \"USDC\", \"USDT\"]) {\n          usdPerUnit[token] ??= 1;\n        }\n        exchangeRate.current = usdPerUnit;\n      }\n    } catch (error) {\n      console.error(\"Error initializing Nexus:\", error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const deinitializeNexus = async () => {\n    try {\n      if (!nexusSDK?.isInitialized())\n        throw new Error(\"Nexus is not initialized\");\n      await nexusSDK?.deinit();\n      setNexusSDK(null);\n      supportedChainsAndTokens.current = null;\n      swapSupportedChainsAndTokens.current = null;\n      unifiedBalance.current = null;\n      exchangeRate.current = null;\n      intent.current = null;\n      swapIntent.current = null;\n      allowance.current = null;\n      setLoading(false);\n    } catch (error) {\n      console.error(\"Error deinitializing Nexus:\", error);\n    }\n  };\n\n  const attachEventHooks = () => {\n    sdk.setOnAllowanceHook((data: OnAllowanceHookData) => {\n      allowance.current = data;\n    });\n\n    sdk.setOnIntentHook((data: OnIntentHookData) => {\n      intent.current = data;\n    });\n\n    sdk.setOnSwapIntentHook((data: OnSwapIntentHookData) => {\n      swapIntent.current = data;\n    });\n  };\n\n  const handleInit = useCallback(\n    async (provider: EthereumProvider) => {\n      if (loading) {\n        return;\n      }\n      if (sdk.isInitialized()) {\n        console.log(\"Nexus already initialized\");\n        return;\n      }\n      if (!provider || typeof (provider as any).request !== \"function\") {\n        throw new Error(\"Invalid EIP-1193 provider\");\n      }\n      await initializeNexus(provider);\n      attachEventHooks();\n    },\n    [sdk, loading, initializeNexus]\n  );\n\n  const fetchUnifiedBalance = async () => {\n    try {\n      const updatedBalance = await sdk?.getUnifiedBalances(true);\n      unifiedBalance.current = updatedBalance;\n    } catch (error) {\n      console.error(\"Error fetching unified balance:\", error);\n    }\n  };\n\n  function getFiatValue(amount: number, token: string) {\n    const key = token.toUpperCase();\n    const rate = Number.parseFloat(String(exchangeRate.current?.[key] ?? \"0\"));\n    const isValid = Number.isFinite(amount) && Number.isFinite(rate);\n    const approx = isValid ? rate * amount : 0;\n\n    return approx;\n  }\n\n  useAccountEffect({\n    onDisconnect() {\n      deinitializeNexus();\n    },\n  });\n\n  const value = useMemo(\n    () => ({\n      nexusSDK,\n      initializeNexus,\n      deinitializeNexus,\n      attachEventHooks,\n      intent,\n      allowance,\n      handleInit,\n      supportedChainsAndTokens: supportedChainsAndTokens.current,\n      swapSupportedChainsAndTokens: swapSupportedChainsAndTokens.current,\n      unifiedBalance: unifiedBalance.current,\n      network: config?.network,\n      loading,\n      fetchUnifiedBalance,\n      swapIntent,\n      exchangeRate: exchangeRate.current,\n      getFiatValue,\n    }),\n    [\n      nexusSDK,\n      initializeNexus,\n      deinitializeNexus,\n      attachEventHooks,\n      intent.current,\n      allowance.current,\n      handleInit,\n      supportedChainsAndTokens.current,\n      swapSupportedChainsAndTokens.current,\n      unifiedBalance.current,\n      config,\n      loading,\n      fetchUnifiedBalance,\n      swapIntent.current,\n      exchangeRate.current,\n      getFiatValue,\n    ]\n  );\n  return (\n    <NexusContext.Provider value={value}>{children}</NexusContext.Provider>\n  );\n};\n\nexport function useNexus() {\n  const context = useContext(NexusContext);\n  if (!context) {\n    throw new Error(\"useNexus must be used within a NexusProvider\");\n  }\n  return context;\n}\n\nexport default NexusProvider;\n",
      "type": "registry:component",
      "target": "components/nexus/NexusProvider.tsx"
    }
  ]
}