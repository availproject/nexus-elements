{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "swap-deposit",
  "type": "registry:component",
  "title": "Swap Deposit",
  "description": "Swap and Deposit tokens across chains and contracts",
  "dependencies": [
    "@avail-project/nexus-core@1.0.0-beta.64",
    "@radix-ui/react-collapsible",
    "@radix-ui/react-separator",
    "@radix-ui/react-tooltip",
    "@radix-ui/react-checkbox",
    "@radix-ui/react-slot",
    "class-variance-authority",
    "clsx",
    "tailwind-merge"
  ],
  "registryDependencies": [
    "https://elements.nexus.availproject.org/r/button.json",
    "https://elements.nexus.availproject.org/r/collapsible.json",
    "https://elements.nexus.availproject.org/r/card.json",
    "https://elements.nexus.availproject.org/r/checkbox.json",
    "https://elements.nexus.availproject.org/r/badge.json",
    "https://elements.nexus.availproject.org/r/tooltip.json",
    "https://elements.nexus.availproject.org/r/separator.json",
    "https://elements.nexus.availproject.org/r/nexus-provider.json",
    "https://elements.nexus.availproject.org/r/utils.json"
  ],
  "files": [
    {
      "path": "registry/nexus-elements/swap-deposit/swap-deposit.tsx",
      "content": "\"use client\";\n\nimport {\n  type ExecuteParams,\n  type SUPPORTED_CHAINS_IDS,\n} from \"@avail-project/nexus-core\";\nimport { type Address } from \"viem\";\nimport { useNexus } from \"../nexus/NexusProvider\";\nimport useSwapDeposit from \"./hooks/useSwapDeposit\";\nimport AssetSelect from \"./components/asset-select\";\nimport { AmountStep } from \"./components/amount-step\";\nimport { ConfirmationStep } from \"./components/confirmation-step\";\nimport TransactionStatusStep from \"./components/transaction-status-step\";\nimport { Card } from \"../ui/card\";\nimport { Button } from \"../ui/button\";\nimport { Loader2, AlertCircle } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface DestinationConfig {\n  chainId: SUPPORTED_CHAINS_IDS;\n  tokenAddress: `0x${string}`;\n  tokenSymbol: string;\n  tokenDecimals: number;\n  tokenLogo?: string;\n  label?: string;\n  estimatedTime?: string;\n  gasTokenSymbol?: string;\n}\n\ninterface SwapDepositProps {\n  executeDeposit: (\n    tokenSymbol: string,\n    tokenAddress: string,\n    amount: bigint,\n    chainId: number,\n    user: Address,\n  ) => Omit<ExecuteParams, \"toChainId\">;\n  destination: DestinationConfig;\n  title?: string;\n}\n\nconst SwapDeposit = ({\n  executeDeposit,\n  destination,\n  title = \"Select Sources\",\n}: SwapDepositProps) => {\n  const { nexusSDK, swapBalance } = useNexus();\n\n  const {\n    status,\n    loading,\n    txError,\n    simulationLoading,\n    timer,\n    availableAssets,\n    selectedSources,\n    totalSelectedBalance,\n    confirmationDetails,\n    feeBreakdown,\n    handleToggleSource,\n    handleSelectAll,\n    handleDeselectAll,\n    handleSourcesContinue,\n    handleAmountContinue,\n    handleConfirmOrder,\n    handleBack,\n    reset,\n    explorerUrls,\n  } = useSwapDeposit({\n    executeDeposit,\n    destination,\n  });\n\n  const isAmountStep =\n    status === \"set-source-assets\" && selectedSources.length > 0;\n  const isProcessing =\n    status === \"swapping\" || status === \"depositing\" || loading;\n  const isSuccess = status === \"success\";\n  const isError = status === \"error\";\n  const showReview = status === \"view-breakdown\";\n\n  if (!nexusSDK) {\n    return (\n      <div className=\"flex h-full items-center justify-center\">\n        <Loader2 className=\"h-5 w-5 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  const renderContent = () => {\n    if (isError && txError) {\n      return (\n        <div className=\"flex h-full flex-col items-center justify-center gap-3 px-6 text-center\">\n          <AlertCircle className=\"h-10 w-10 text-destructive\" />\n          <p className=\"text-sm text-muted-foreground\">{txError}</p>\n          <Button onClick={reset}>Try again</Button>\n        </div>\n      );\n    }\n\n    if (isSuccess || isProcessing) {\n      return (\n        <TransactionStatusStep\n          details={{\n            sourceLabel: confirmationDetails?.sourceLabel ?? \"\",\n            successTitle: `Deposit ${destination.tokenSymbol}`,\n            sources: confirmationDetails?.sources,\n            gasTokenSymbol: confirmationDetails?.gasTokenSymbol,\n            networkCost: feeBreakdown?.gasUsd,\n          }}\n          receiveAmount={confirmationDetails?.receiveAmountAfterSwap ?? \"\"}\n          tokenLogo={destination.tokenLogo ?? \"\"}\n          totalTime={\n            status === \"success\"\n              ? `${Math.max(1, Math.floor(timer))}s`\n              : undefined\n          }\n          onClose={reset}\n          onNewDeposit={reset}\n          status={status}\n          explorerUrls={\n            explorerUrls ?? {\n              source: null,\n              destination: null,\n              depositUrl: null,\n            }\n          }\n        />\n      );\n    }\n\n    if (showReview) {\n      // Show confirmation step - with skeletons if still simulating\n      const defaultDetails = {\n        sourceLabel: destination.label ?? \"Source route\",\n        sources: selectedSources,\n        gasTokenSymbol: destination.gasTokenSymbol,\n        estimatedTime: destination.estimatedTime ?? \"≈ 30s\",\n        amountSpent: \"\",\n        receiveTokenSymbol: destination.tokenSymbol,\n        receiveAmountAfterSwap: \"\",\n        receiveTokenChain: destination.chainId,\n        receiveTokenLogo: destination.tokenLogo,\n        networkCost: feeBreakdown?.gasFormatted ?? \"\",\n      };\n\n      return (\n        <div className=\"flex h-full flex-col\">\n          <ConfirmationStep\n            amount={confirmationDetails?.receiveAmountAfterSwapUsd ?? 0}\n            details={\n              confirmationDetails\n                ? {\n                    ...confirmationDetails,\n                    sourceLabel:\n                      confirmationDetails.sourceLabel ??\n                      destination.label ??\n                      \"Source route\",\n                    networkCost: feeBreakdown?.gasFormatted ?? \"\",\n                  }\n                : defaultDetails\n            }\n            countdown={Math.max(0, 15 - Math.floor(timer))}\n            onConfirm={handleConfirmOrder}\n            onBack={handleBack}\n            title={destination.label ?? destination.tokenSymbol}\n            isSimulating={simulationLoading}\n          />\n        </div>\n      );\n    }\n\n    if (isAmountStep) {\n      // Show amount step - using total selected balance as max\n      const primarySource = selectedSources[0];\n      return (\n        <AmountStep\n          token={{\n            symbol:\n              selectedSources.length === 1 ? primarySource.symbol : \"Multiple\",\n            maxAmount: totalSelectedBalance,\n            readableBalance: `${totalSelectedBalance} (${selectedSources.length} sources)`,\n            sources: selectedSources,\n            receiveSymbol: destination.tokenSymbol,\n            receiveTokenLogo: destination.tokenLogo,\n            receiveTokenDecimals: destination.tokenDecimals,\n            receiveChainId: destination.chainId,\n          }}\n          onContinue={handleAmountContinue}\n          onBack={reset}\n          onClose={reset}\n        />\n      );\n    }\n\n    // Default: show asset selection\n    return (\n      <AssetSelect\n        title={title}\n        availableAssets={availableAssets}\n        selectedSources={selectedSources}\n        onToggle={handleToggleSource}\n        onSelectAll={handleSelectAll}\n        onDeselectAll={handleDeselectAll}\n        onContinue={handleSourcesContinue}\n        onBack={reset}\n        onClose={reset}\n        emptyLabel={\n          swapBalance\n            ? \"No swappable assets found\"\n            : \"Fetching swappable tokens\"\n        }\n      />\n    );\n  };\n\n  return (\n    <Card\n      className={cn(\n        \"relative mx-auto h-[520px] py-0 w-full max-w-md overflow-y-scroll no-scrollbar\",\n      )}\n    >\n      {renderContent()}\n    </Card>\n  );\n};\n\nexport default SwapDeposit;\n",
      "type": "registry:component",
      "target": "components/swap-deposit/swap-deposit.tsx"
    },
    {
      "path": "registry/nexus-elements/common/index.ts",
      "content": "export * from \"./hooks/useStopwatch\";\nexport * from \"./hooks/usePolling\";\nexport * from \"./hooks/useInterval\";\nexport * from \"./hooks/useStableCallback\";\nexport * from \"./hooks/useDebouncedValue\";\nexport * from \"./hooks/useDebouncedCallback\";\nexport * from \"./hooks/useNexusError\";\nexport * from \"./tx/types\";\nexport * from \"./tx/steps\";\nexport * from \"./tx/useTransactionSteps\";\nexport * from \"./utils/constant\";\n",
      "type": "registry:component",
      "target": "components/common/index.ts"
    },
    {
      "path": "registry/nexus-elements/common/utils/constant.ts",
      "content": "import { formatUnits, parseUnits } from \"viem\";\n\nexport const SHORT_CHAIN_NAME: Record<number, string> = {\n  1: \"Ethereum\",\n  8453: \"Base\",\n  42161: \"Arbitrum\",\n  10: \"Optimism\",\n  137: \"Polygon\",\n  43114: \"Avalanche\",\n  534352: \"Scroll\",\n  50104: \"Sophon\",\n  8217: \"Kaia\",\n  56: \"BNB\",\n  143: \"Monad\",\n  999: \"HyperEVM\",\n  728126428: \"Tron\",\n  11155111: \"Sepolia\",\n  84532: \"Base Sepolia\",\n  421614: \"Arbitrum Sepolia\",\n  11155420: \"Optimism Sepolia\",\n  80002: \"Polygon Amoy\",\n  10143: \"Monad Testnet\",\n  2494104990: \"Tron Shasta\",\n  567: \"Validium Testnet\",\n} as const;\n\nconst DEFAULT_SAFETY_MARGIN = 0.01; // 1%\n\n/**\n * Compute an amount string for fraction buttons (25%, 50%, 75%, 100%).\n *\n * @param balanceStr - user's balance as a human decimal string (e.g. \"12.345\") OR as base-unit integer string if `balanceIsBaseUnits` true\n * @param fraction - fraction e.g. 0.25, 0.5, 0.75, 1\n * @param decimals - token decimals (6 for USDC/USDT, 18 for ETH)\n * @param safetyMargin - 0.01 for 1% default\n * @param balanceIsBaseUnits - if true, balanceStr is already base units integer string (wei / smallest unit)\n * @returns decimal string clipped to token decimals (rounded down)\n */\nexport function computeAmountFromFraction(\n  balanceStr: string,\n  fraction: number,\n  decimals: number,\n  safetyMargin = DEFAULT_SAFETY_MARGIN,\n  balanceIsBaseUnits = false,\n): string {\n  if (!balanceStr) return \"0\";\n\n  // parse balance into base units (BigInt)\n  const balanceUnits: bigint = balanceIsBaseUnits\n    ? BigInt(balanceStr)\n    : parseUnits(balanceStr, decimals);\n\n  if (balanceUnits === BigInt(0)) return \"0\";\n\n  // Use an integer precision multiplier to avoid FP issues\n  const PREC = 1_000_000; // 1e6 precision for fraction & safety margin\n  const safetyMul = BigInt(Math.max(0, Math.floor((1 - safetyMargin) * PREC))); // (1 - safetyMargin) * PREC\n  const fractionMul = BigInt(Math.max(0, Math.floor(fraction * PREC))); // fraction * PREC\n\n  // Apply safety margin: floor(balance * (1 - safetyMargin))\n  const maxAfterSafety = (balanceUnits * safetyMul) / BigInt(PREC);\n\n  // Apply fraction and floor: floor(maxAfterSafety * fraction)\n  let desiredUnits = (maxAfterSafety * fractionMul) / BigInt(PREC);\n\n  // Extra clamp just in case\n  if (desiredUnits > balanceUnits) desiredUnits = balanceUnits;\n  if (desiredUnits < BigInt(0)) desiredUnits = BigInt(0);\n\n  // format back to human readable decimal string with token decimals (formatUnits truncates/keeps decimals)\n  // formatUnits will produce exactly decimals digits if fractional part exists; we'll strip trailing zeros.\n  const raw = formatUnits(desiredUnits, decimals);\n  // strip trailing zeros and possible trailing dot\n  return raw\n    .replace(/(\\.\\d*?[1-9])0+$/u, \"$1\")\n    .replace(/\\.0+$/u, \"\")\n    .replace(/^\\.$/u, \"0\");\n}\n\nexport const usdFormatter = new Intl.NumberFormat(\"en-US\", {\n  style: \"currency\",\n  currency: \"USD\",\n  minimumFractionDigits: 2,\n  maximumFractionDigits: 2,\n});\n",
      "type": "registry:component",
      "target": "components/common/utils/constant.ts"
    },
    {
      "path": "registry/nexus-elements/common/hooks/useStableCallback.ts",
      "content": "import { useCallback, useRef } from \"react\";\n\n/**\n * Returns a stable function identity that always calls the latest implementation.\n * Useful when passing callbacks to memoized children without re-creating handlers.\n */\nexport function useStableCallback<Args extends readonly unknown[], Return>(\n  fn: (...args: Args) => Return\n): (...args: Args) => Return {\n  const fnRef = useRef<(...args: Args) => Return>(fn);\n  fnRef.current = fn;\n\n   \n  const stable = useCallback(\n    ((...args: Args) => {\n      return fnRef.current(...args);\n    }) as (...args: Args) => Return,\n    []\n  );\n\n  return stable;\n}\n",
      "type": "registry:component",
      "target": "components/common/hooks/useStableCallback.ts"
    },
    {
      "path": "registry/nexus-elements/common/hooks/useNexusError.ts",
      "content": "import { NexusError } from \"@avail-project/nexus-core\";\n\nfunction handler(err: unknown) {\n  if (err instanceof NexusError) {\n    return {\n      code: err?.code,\n      message: err?.message,\n      context: err?.data?.context,\n      details: err?.data?.details,\n    };\n  } else {\n    console.error(\"Unexpected error:\", err);\n    return {\n      code: \"unexpected_error\",\n      message: \"Oops! Something went wrong. Please try again.\",\n      context: undefined,\n      details: undefined,\n    };\n  }\n}\nexport function useNexusError() {\n  return handler;\n}\n",
      "type": "registry:component",
      "target": "components/common/hooks/useNexusError.ts"
    },
    {
      "path": "registry/nexus-elements/common/hooks/useInterval.ts",
      "content": "import { useEffect, useRef } from \"react\";\nimport { useStableCallback } from \"./useStableCallback\";\n\ninterface UseIntervalOptions {\n  enabled?: boolean;\n  immediate?: boolean;\n}\n\n/**\n * Declarative setInterval with pause/resume and latest-callback semantics.\n * Pass delay=null to pause.\n */\nexport function useInterval(\n  callback: () => void,\n  delay: number | null,\n  options: UseIntervalOptions = {}\n) {\n  const { enabled = true, immediate = false } = options;\n  const savedCallback = useStableCallback(callback);\n  const intervalRef = useRef<NodeJS.Timeout | null>(null);\n\n  useEffect(() => {\n    if (!enabled || delay == null) return;\n    if (immediate) {\n      savedCallback();\n    }\n    intervalRef.current = setInterval(savedCallback, delay);\n    return () => {\n      if (intervalRef.current) {\n        clearInterval(intervalRef.current);\n        intervalRef.current = null;\n      }\n    };\n  }, [delay, enabled, immediate, savedCallback]);\n}\n",
      "type": "registry:component",
      "target": "components/common/hooks/useInterval.ts"
    },
    {
      "path": "registry/nexus-elements/common/hooks/useStopwatch.ts",
      "content": "import { useEffect, useRef, useState } from \"react\";\n\ninterface UseStopwatchOptions {\n  running?: boolean;\n  intervalMs?: number;\n}\n\n/**\n * Simple stopwatch that increments elapsed seconds while running.\n * Designed to replace scattered timer effects.\n */\nexport function useStopwatch(options: UseStopwatchOptions = {}) {\n  const { running = false, intervalMs = 100 } = options;\n  const [elapsedSeconds, setElapsedSeconds] = useState(0);\n  const timerRef = useRef<ReturnType<typeof setInterval> | null>(null);\n\n  const reset = () => {\n    setElapsedSeconds(0);\n  };\n\n  const stop = () => {\n    if (timerRef.current) {\n      clearInterval(timerRef.current);\n      timerRef.current = null;\n    }\n  };\n\n  const start = () => {\n    if (timerRef.current) return;\n    timerRef.current = setInterval(() => {\n      // 1s == 1000ms; we add fractional seconds per tick\n      setElapsedSeconds((prev) => prev + intervalMs / 1000);\n    }, intervalMs);\n  };\n\n  useEffect(() => {\n    if (running) {\n      start();\n    } else {\n      stop();\n    }\n    return stop;\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [running, intervalMs]);\n\n  return {\n    seconds: elapsedSeconds,\n    start,\n    stop,\n    reset,\n    running: Boolean(timerRef.current),\n  };\n}\n",
      "type": "registry:component",
      "target": "components/common/hooks/useStopwatch.ts"
    },
    {
      "path": "registry/nexus-elements/common/hooks/usePolling.ts",
      "content": "import { useRef } from \"react\";\nimport { useInterval } from \"./useInterval\";\nimport { useStableCallback } from \"./useStableCallback\";\n\n/**\n * Declarative polling with in-flight protection (no overlap).\n * When enabled becomes true, an immediate run is executed,\n * followed by interval-based runs.\n */\nexport function usePolling(\n  enabled: boolean,\n  fn: () => Promise<void> | void,\n  intervalMs: number\n) {\n  const inFlightRef = useRef(false);\n  const wrapped = useStableCallback(async () => {\n    if (inFlightRef.current) return;\n    try {\n      inFlightRef.current = true;\n      await fn();\n    } catch (error) {\n      console.error(error);\n    } finally {\n      inFlightRef.current = false;\n    }\n  });\n\n  useInterval(wrapped, enabled ? intervalMs : null, {\n    enabled,\n    immediate: enabled,\n  });\n}\n",
      "type": "registry:component",
      "target": "components/common/hooks/usePolling.ts"
    },
    {
      "path": "registry/nexus-elements/common/hooks/useDebouncedCallback.ts",
      "content": "import { useEffect, useMemo, useRef } from \"react\";\nimport { useStableCallback } from \"./useStableCallback\";\n\ntype AnyFn = (...args: any[]) => any;\n\nexport interface Debounced<T extends AnyFn> {\n  (...args: Parameters<T>): void;\n  cancel: () => void;\n  flush: () => void;\n}\n\n/**\n * Returns a debounced function that delays invoking `fn` until after `delay`\n * milliseconds have elapsed since the last call.\n */\nexport function useDebouncedCallback<T extends AnyFn>(\n  fn: T,\n  delay: number\n): Debounced<T> {\n  const latest = useStableCallback(fn);\n  const timerRef = useRef<NodeJS.Timeout | null>(null);\n  const lastArgsRef = useRef<Parameters<T> | null>(null);\n\n  const cancel = () => {\n    if (timerRef.current) {\n      clearTimeout(timerRef.current);\n      timerRef.current = null;\n    }\n  };\n\n  const flush = () => {\n    if (timerRef.current && lastArgsRef.current) {\n      clearTimeout(timerRef.current);\n      timerRef.current = null;\n       \n      latest(...lastArgsRef.current);\n      lastArgsRef.current = null;\n    }\n  };\n\n  // cancel when delay changes/unmounts\n  useEffect(() => cancel, [delay]);\n\n  return useMemo(() => {\n    const debounced = ((...args: Parameters<T>) => {\n      lastArgsRef.current = args;\n      cancel();\n      timerRef.current = setTimeout(() => {\n         \n        latest(...lastArgsRef.current!);\n        lastArgsRef.current = null;\n        timerRef.current = null;\n      }, delay);\n    }) as Debounced<T>;\n    debounced.cancel = cancel;\n    debounced.flush = flush;\n    return debounced;\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [delay, latest]);\n}\n",
      "type": "registry:component",
      "target": "components/common/hooks/useDebouncedCallback.ts"
    },
    {
      "path": "registry/nexus-elements/common/hooks/useDebouncedValue.ts",
      "content": "import { useEffect, useState } from \"react\";\nimport { useDebouncedCallback } from \"./useDebouncedCallback\";\n\n/**\n * Derives a debounced value from an input value and delay.\n */\nexport function useDebouncedValue<T>(value: T, delay: number): T {\n  const [debounced, setDebounced] = useState<T>(value);\n  const setter = useDebouncedCallback((v: T) => setDebounced(v), delay);\n\n  useEffect(() => {\n    setter(value);\n    return setter.cancel;\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [value, delay]);\n\n  return debounced;\n}\n",
      "type": "registry:component",
      "target": "components/common/hooks/useDebouncedValue.ts"
    },
    {
      "path": "registry/nexus-elements/common/tx/types.ts",
      "content": "export type TransactionStatus =\n  | \"idle\"\n  | \"preview\"\n  | \"awaiting-approval\"\n  | \"executing\"\n  | \"success\"\n  | \"error\";\n\nexport type GenericStep<TStep> = {\n  id: number;\n  completed: boolean;\n  step: TStep;\n};\n\n/**\n * Normalizes a step to a stable key. Prefers typeID, then type, otherwise JSON.\n */\nexport function getStepKey(step: any): string {\n  if (!step) return \"\";\n  if (typeof step.typeID === \"string\" && step.typeID.length > 0) {\n    return step.typeID;\n  }\n  if (typeof step.type === \"string\" && step.type.length > 0) {\n    return step.type;\n  }\n  try {\n    return JSON.stringify(step);\n  } catch {\n    return String(step);\n  }\n}\n",
      "type": "registry:component",
      "target": "components/common/tx/types.ts"
    },
    {
      "path": "registry/nexus-elements/common/tx/steps.ts",
      "content": "import type { SwapStepType } from \"@avail-project/nexus-core\";\nimport type { GenericStep } from \"./types\";\nimport { getStepKey } from \"./types\";\n\n/**\n * Predefined expected steps for swaps to seed UI before events arrive.\n * Kept here to avoid duplication across exact-in and exact-out hooks.\n */\nexport const SWAP_EXPECTED_STEPS: SwapStepType[] = [\n  { type: \"SWAP_START\", typeID: \"SWAP_START\" } as SwapStepType,\n  { type: \"DETERMINING_SWAP\", typeID: \"DETERMINING_SWAP\" } as SwapStepType,\n  {\n    type: \"CREATE_PERMIT_FOR_SOURCE_SWAP\",\n    typeID:\n      \"CREATE_PERMIT_FOR_SOURCE_SWAP\" as unknown as SwapStepType[\"typeID\"],\n  } as SwapStepType,\n  {\n    type: \"SOURCE_SWAP_BATCH_TX\",\n    typeID: \"SOURCE_SWAP_BATCH_TX\",\n  } as SwapStepType,\n  {\n    type: \"SOURCE_SWAP_HASH\",\n    typeID: \"SOURCE_SWAP_HASH\" as unknown as SwapStepType[\"typeID\"],\n  } as SwapStepType,\n  { type: \"RFF_ID\", typeID: \"RFF_ID\" } as SwapStepType,\n  {\n    type: \"DESTINATION_SWAP_BATCH_TX\",\n    typeID: \"DESTINATION_SWAP_BATCH_TX\",\n  } as SwapStepType,\n  {\n    type: \"DESTINATION_SWAP_HASH\",\n    typeID: \"DESTINATION_SWAP_HASH\" as unknown as SwapStepType[\"typeID\"],\n  } as SwapStepType,\n  { type: \"SWAP_COMPLETE\", typeID: \"SWAP_COMPLETE\" } as SwapStepType,\n];\n\nexport function seedSteps<T>(expected: T[]): Array<GenericStep<T>> {\n  return expected.map((st, index) => ({\n    id: index,\n    completed: false,\n    step: st,\n  }));\n}\n\nexport function computeAllCompleted<T>(steps: Array<GenericStep<T>>): boolean {\n  return steps.length > 0 && steps.every((s) => s.completed);\n}\n\n/**\n * Replace the current list of steps with a new list, preserving completion\n * for any steps that were already marked completed (matched by key).\n */\nexport function mergeStepsList<T>(\n  prev: Array<GenericStep<T>>,\n  list: T[]\n): Array<GenericStep<T>> {\n  const completedKeys = new Set<string>();\n  for (const prevStep of prev) {\n    if (prevStep.completed) {\n      completedKeys.add(getStepKey(prevStep.step));\n    }\n  }\n  const next: Array<GenericStep<T>> = [];\n  for (let index = 0; index < list.length; index++) {\n    const step = list[index];\n    const key = getStepKey(step);\n    next.push({\n      id: index,\n      completed: completedKeys.has(key),\n      step,\n    });\n  }\n  return next;\n}\n\n/**\n * Mark a step complete in-place; if the step doesn't yet exist, append it.\n */\nexport function mergeStepComplete<T>(\n  prev: Array<GenericStep<T>>,\n  step: T\n): Array<GenericStep<T>> {\n  const key = getStepKey(step);\n  const updated: Array<GenericStep<T>> = [];\n  let found = false;\n  for (const s of prev) {\n    if (getStepKey(s.step) === key) {\n      updated.push({ ...s, completed: true, step: { ...s.step, ...step } });\n      found = true;\n    } else {\n      updated.push(s);\n    }\n  }\n  if (!found) {\n    updated.push({\n      id: updated.length,\n      completed: true,\n      step,\n    });\n  }\n  return updated;\n}\n",
      "type": "registry:component",
      "target": "components/common/tx/steps.ts"
    },
    {
      "path": "registry/nexus-elements/common/tx/useTransactionSteps.ts",
      "content": "import { useMemo, useRef, useState } from \"react\";\nimport type { GenericStep } from \"./types\";\nimport { getStepKey } from \"./types\";\nimport {\n  computeAllCompleted,\n  mergeStepComplete,\n  mergeStepsList,\n  seedSteps,\n} from \"./steps\";\n\ninterface UseTransactionStepsOptions<T> {\n  expected?: T[];\n}\n\n/**\n * Manages transaction steps with utilities to seed from expected steps,\n * replace the list on \"steps list\" events, and mark individual steps complete.\n */\nexport function useTransactionSteps<\n  T extends { typeID?: string; type?: string }\n>(options: UseTransactionStepsOptions<T> = {}) {\n  const { expected } = options;\n  const [steps, setSteps] = useState<Array<GenericStep<T>>>(() =>\n    expected ? seedSteps(expected) : []\n  );\n  const lastSignatureRef = useRef<string>(\"\");\n\n  const onStepsList = (list: T[]) => {\n    const signature = list.map((step) => getStepKey(step)).join(\"|\");\n    if (lastSignatureRef.current === signature) {\n      setSteps((prev) => mergeStepsList(prev, list));\n      return;\n    }\n    lastSignatureRef.current = signature;\n    setSteps((prev) => mergeStepsList(prev, list));\n  };\n\n  const onStepComplete = (step: T) => {\n    setSteps((prev) => mergeStepComplete(prev, step));\n  };\n\n  const seed = (expectedSteps: T[]) => {\n    setSteps(seedSteps(expectedSteps));\n  };\n\n  const reset = () => {\n    setSteps(expected ? seedSteps(expected) : []);\n    lastSignatureRef.current = \"\";\n  };\n\n  const allCompleted = useMemo(() => computeAllCompleted(steps), [steps]);\n\n  return {\n    steps,\n    allCompleted,\n    onStepsList,\n    onStepComplete,\n    seed,\n    reset,\n  };\n}\n",
      "type": "registry:component",
      "target": "components/common/tx/useTransactionSteps.ts"
    },
    {
      "path": "registry/nexus-elements/swap-deposit/components/asset-select.tsx",
      "content": "\"use client\";\n\nimport { DepositHeader } from \"./deposit-header\";\nimport { TokenIcon } from \"./token-icon\";\nimport { Button } from \"../../ui/button\";\nimport { Badge } from \"../../ui/badge\";\nimport { Checkbox } from \"../../ui/checkbox\";\nimport { cn } from \"@/lib/utils\";\nimport { useNexus } from \"../../nexus/NexusProvider\";\nimport { usdFormatter } from \"../../common\";\n\n// Selection result containing the data needed for inputs\nexport interface AssetSelection {\n  chainId: number;\n  tokenAddress: `0x${string}`;\n  decimals: number;\n  symbol: string;\n  balance: string;\n  balanceInFiat: number;\n  tokenLogo?: string;\n  chainLogo?: string;\n  chainName?: string;\n}\n\ninterface AssetSelectProps {\n  title?: string;\n  availableAssets: AssetSelection[];\n  selectedSources: AssetSelection[];\n  onToggle: (source: AssetSelection) => void;\n  onSelectAll: () => void;\n  onDeselectAll: () => void;\n  onContinue: () => void;\n  onBack: () => void;\n  onClose: () => void;\n  emptyLabel?: string;\n  ctaLabel?: string;\n}\n\nconst LOW_BALANCE_THRESHOLD = 5;\n\nconst AssetSelect = ({\n  title = \"Select Sources\",\n  availableAssets,\n  selectedSources,\n  onToggle,\n  // onSelectAll,\n  // onDeselectAll,\n  onContinue,\n  onBack,\n  onClose,\n  emptyLabel = \"No swappable assets found\",\n  ctaLabel = \"Continue\",\n}: AssetSelectProps) => {\n  const { nexusSDK } = useNexus();\n\n  const isSourceSelected = (source: AssetSelection) => {\n    const sourceId = `${source.symbol}-${source.chainId}-${source.tokenAddress}`;\n    return selectedSources.some(\n      (s) => `${s.symbol}-${s.chainId}-${s.tokenAddress}` === sourceId,\n    );\n  };\n\n  // const allSelected =\n  //   availableAssets.length > 0 &&\n  //   selectedSources.length === availableAssets.length;\n  const noneSelected = selectedSources.length === 0;\n\n  return (\n    <div className=\"flex h-full flex-col bg-background no-scrollbar\">\n      <DepositHeader\n        title={title}\n        onBack={onBack}\n        onClose={onClose}\n        showClose\n      />\n\n      <div className=\"flex-1 overflow-y-auto px-4 py-3 no-scrollbar\">\n        {availableAssets.length === 0 ? (\n          <div className=\"flex h-40 flex-col items-center justify-center rounded-xl border border-dashed border-border text-sm text-muted-foreground\">\n            {emptyLabel}\n          </div>\n        ) : (\n          <>\n            {/* Select All / Deselect All buttons */}\n            {/* <div className=\"mb-3 flex gap-2\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={onSelectAll}\n                disabled={allSelected}\n                className=\"flex-1\"\n              >\n                Select All\n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={onDeselectAll}\n                disabled={noneSelected}\n                className=\"flex-1\"\n              >\n                Deselect All\n              </Button>\n            </div> */}\n\n            <ul className=\"space-y-1.5\">\n              {availableAssets.map((option) => {\n                const sourceId = `${option.symbol}-${option.chainId}-${option.tokenAddress}`;\n                const isSelected = isSourceSelected(option);\n                const numericBalance = Number.parseFloat(option.balance);\n                const usdValue = option.balanceInFiat;\n                const isLowBalance = numericBalance < LOW_BALANCE_THRESHOLD;\n\n                return (\n                  <li key={sourceId}>\n                    <div\n                      className={cn(\n                        \"flex h-auto w-full items-center justify-between rounded-xl p-3 transition-colors\",\n                        isSelected\n                          ? \"bg-secondary/50 hover:bg-background\"\n                          : \"hover:bg-secondary/50\",\n                      )}\n                    >\n                      <div className=\"flex items-center gap-x-3 text-left\">\n                        <Checkbox\n                          checked={isSelected}\n                          onCheckedChange={() => onToggle(option)}\n                        />\n                        <TokenIcon\n                          symbol={option.symbol}\n                          tokenLogo={option.tokenLogo}\n                          chainLogo={option.chainLogo}\n                          size=\"sm\"\n                        />\n                        <div>\n                          <p className=\"font-medium text-foreground\">\n                            {option.symbol}\n                          </p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            {nexusSDK?.utils?.formatTokenBalance(\n                              option.balance,\n                              {\n                                symbol: option.symbol,\n                                decimals: option.decimals,\n                              },\n                            )}\n                          </p>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-x-2\">\n                        {isLowBalance && (\n                          <Badge\n                            variant=\"secondary\"\n                            className=\"bg-secondary text-muted-foreground text-[10px]\"\n                          >\n                            Low Balance\n                          </Badge>\n                        )}\n                        <span className=\"text-sm font-medium text-foreground\">\n                          {usdFormatter.format(usdValue)}\n                        </span>\n                      </div>\n                    </div>\n                  </li>\n                );\n              })}\n            </ul>\n          </>\n        )}\n      </div>\n\n      <div className=\"border-t border-border p-4\">\n        <Button\n          onClick={onContinue}\n          disabled={noneSelected}\n          className=\"w-full rounded-xl text-base font-medium\"\n        >\n          {ctaLabel} ({selectedSources.length} selected)\n        </Button>\n      </div>\n    </div>\n  );\n};\n\nexport default AssetSelect;\n",
      "type": "registry:component",
      "target": "components/swap-deposit/components/asset-select.tsx"
    },
    {
      "path": "registry/nexus-elements/swap-deposit/components/amount-step.tsx",
      "content": "\"use client\";\n\nimport { useState, useCallback, useRef, useEffect } from \"react\";\nimport { DepositHeader } from \"./deposit-header\";\nimport { TokenIcon } from \"./token-icon\";\nimport { Button } from \"../../ui/button\";\nimport { cn } from \"@/lib/utils\";\nimport { ArrowRight } from \"lucide-react\";\nimport { useNexus } from \"../../nexus/NexusProvider\";\nimport { CHAIN_METADATA } from \"@avail-project/nexus-core\";\nimport { type AssetSelection } from \"./asset-select\";\n\nconst PERCENTAGES = [25, 50, 75, 100];\n\nexport interface AmountStepToken {\n  symbol: string;\n  maxAmount: number;\n  readableBalance: string;\n  sources?: AssetSelection[];\n  receiveSymbol?: string;\n  receiveTokenLogo?: string;\n  receiveTokenDecimals?: number;\n  receiveChainId: number;\n}\n\ninterface AmountStepProps {\n  token: AmountStepToken;\n  onContinue: (amount: number) => void;\n  onBack: () => void;\n  onClose: () => void;\n  title?: string;\n}\n\nexport const AmountStep = ({\n  token,\n  onContinue,\n  onBack,\n  onClose,\n  title = \"Deposit USDC\",\n}: AmountStepProps) => {\n  const { getFiatValue } = useNexus();\n  const [amount, setAmount] = useState<string>(\"\");\n  const [selectedPercent, setSelectedPercent] = useState<number | null>(null);\n  const receiveSymbol = token.receiveSymbol ?? \"USDC\";\n  const inputRef = useRef<HTMLInputElement>(null);\n  const mirrorRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    if (mirrorRef.current && inputRef.current) {\n      const inputWidth = mirrorRef.current.offsetWidth;\n      inputRef.current.style.width = `${Math.max(inputWidth + 8, 24)}px`;\n    }\n  }, [amount]);\n\n  const handlePercentClick = useCallback(\n    (percent: number) => {\n      setSelectedPercent(percent);\n      const computed =\n        percent === 100 ? token.maxAmount : (token.maxAmount * percent) / 100;\n      setAmount(computed.toFixed(token.receiveTokenDecimals));\n    },\n    [token.maxAmount]\n  );\n\n  const handleAmountChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const inputValue = e.target.value;\n    const numericValue = inputValue.replaceAll(/[^0-9.]/g, \"\");\n    setAmount(numericValue);\n    setSelectedPercent(null);\n  };\n\n  const receiveAmount = Number.parseFloat(amount) || 0;\n  const isDisabled =\n    receiveAmount <= 0 ||\n    Number.isNaN(receiveAmount) ||\n    receiveAmount > token.maxAmount;\n\n  return (\n    <div className=\"flex h-full flex-col bg-background\">\n      <DepositHeader\n        title={title}\n        onBack={onBack}\n        onClose={onClose}\n        showClose\n      />\n\n      <div className=\"flex flex-1 flex-col items-center justify-center gap-4 px-4\">\n        <div className=\"relative w-full max-w-xs text-center flex flex-col gap-y-2 items-center justify-center\">\n          <div className=\"flex items-baseline gap-2 text-5xl font-medium transition-all duration-150 ease-out w-fit\">\n            <div className=\"text-foreground font-medium whitespace-nowrap\">\n              $\n            </div>\n            <div className=\"relative flex items-baseline\">\n              <div\n                ref={mirrorRef}\n                className=\"absolute invisible pointer-events-none text-5xl font-medium whitespace-pre\"\n                style={{\n                  fontVariantNumeric: \"proportional-nums\",\n                }}\n              >\n                {amount || \"0\"}\n              </div>\n\n              <input\n                ref={inputRef}\n                type=\"text\"\n                inputMode=\"decimal\"\n                placeholder=\"0\"\n                value={amount}\n                onChange={handleAmountChange}\n                autoFocus\n                className=\"bg-transparent text-foreground text-5xl font-medium outline-none transition-all duration-150 placeholder-muted-foreground\"\n                style={{\n                  fontVariantNumeric: \"proportional-nums\",\n                  width: \"24px\",\n                }}\n                maxLength={6}\n              />\n              <div className=\"absolute -inset-1 -z-10 blur-sm pointer-events-none opacity-0\" />\n            </div>\n          </div>\n          <p className=\"text-xs text-muted-foreground\">\n            Balance: ${token.maxAmount.toFixed(4)}\n          </p>\n        </div>\n\n        <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n          <span>≈</span>\n          <span>\n            {getFiatValue(receiveAmount, receiveSymbol)} {receiveSymbol}\n          </span>\n        </div>\n\n        <div className=\"flex flex-wrap items-center justify-center gap-2\">\n          {PERCENTAGES.map((percent) => (\n            <Button\n              key={percent}\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => handlePercentClick(percent)}\n              className={cn(\n                \"rounded-lg px-4 text-sm\",\n                selectedPercent === percent\n                  ? \"bg-secondary text-foreground\"\n                  : \"bg-transparent text-muted-foreground hover:bg-secondary\"\n              )}\n            >\n              {percent === 100 ? \"Max\" : `${percent}%`}\n            </Button>\n          ))}\n        </div>\n      </div>\n\n      <div className=\"space-y-4 p-4\">\n        <div className=\"flex items-center justify-center gap-3 px-4 py-2 border border-border rounded-full w-max mx-auto\">\n          <div className=\"flex items-center gap-2 text-sm\">\n            <div className=\"max-w-40 overflow-x-scroll no-scrollbar flex items-center\">\n              {token.sources?.map((source, index) => (\n                <TokenIcon\n                  key={source.tokenAddress}\n                  symbol={source.symbol}\n                  tokenLogo={source.tokenLogo}\n                  chainLogo={source.chainLogo}\n                  size=\"sm\"\n                  className={cn(\n                    \"last:mr-0 size-6\",\n                    index !== (token.sources?.length ?? 0) - 1 &&\n                      token?.sources?.length &&\n                      token.sources.length > 5\n                      ? \"-mr-5\"\n                      : \"-mr-3\"\n                  )}\n                />\n              ))}\n            </div>\n\n            <div>\n              <p className=\"text-muted-foreground text-xs\">You send</p>\n              <p className=\"font-medium text-foreground\">{token.symbol}</p>\n            </div>\n          </div>\n          <ArrowRight className=\"h-4 w-4 text-muted-foreground\" />\n          <div className=\"flex items-center gap-2 text-sm\">\n            <TokenIcon\n              symbol={receiveSymbol}\n              tokenLogo={token.receiveTokenLogo}\n              chainLogo={CHAIN_METADATA[token.receiveChainId].logo}\n              size=\"sm\"\n            />\n            <div>\n              <p className=\"text-muted-foreground text-xs\">You receive</p>\n              <p className=\"font-medium text-foreground\">{receiveSymbol}</p>\n            </div>\n          </div>\n        </div>\n\n        <Button\n          onClick={() => onContinue(receiveAmount)}\n          disabled={isDisabled}\n          className=\"w-full rounded-xl text-base font-medium\"\n        >\n          Continue\n        </Button>\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component",
      "target": "components/swap-deposit/components/amount-step.tsx"
    },
    {
      "path": "registry/nexus-elements/swap-deposit/components/confirmation-step.tsx",
      "content": "\"use client\";\n\nimport { useState } from \"react\";\nimport { DepositHeader } from \"./deposit-header\";\nimport { TokenIcon } from \"./token-icon\";\nimport { InfoRow, InfoCard } from \"./info\";\nimport { Button } from \"../../ui/button\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/registry/nexus-elements/ui/collapsible\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"../../ui/tooltip\";\nimport { Skeleton } from \"../../ui/skeleton\";\nimport { ChevronRight, Fuel, Info } from \"lucide-react\";\nimport { type SUPPORTED_CHAINS_IDS } from \"@avail-project/nexus-core\";\nimport { type AssetSelection } from \"./asset-select\";\nimport { cn } from \"@/lib/utils\";\nimport { Separator } from \"../../ui/separator\";\n\nexport interface ConfirmationDetails {\n  sourceLabel: string;\n  sources: (AssetSelection | undefined)[];\n  gasTokenSymbol?: string;\n  estimatedTime?: string;\n  amountSpent: string;\n  receiveTokenSymbol: string;\n  receiveAmountAfterSwap: string;\n  receiveTokenChain: SUPPORTED_CHAINS_IDS;\n  receiveTokenLogo?: string;\n  networkCost?: string;\n}\n\ninterface ConfirmationStepProps {\n  amount: number;\n  details: ConfirmationDetails;\n  isSimulating: boolean;\n  countdown?: number;\n  onConfirm: () => void;\n  onBack: () => void;\n  title?: string;\n}\n\nexport const ConfirmationStep = ({\n  amount,\n  details,\n  countdown,\n  onConfirm,\n  onBack,\n  title = \"Deposit USDC\",\n  isSimulating = false,\n}: ConfirmationStepProps) => {\n  const [open, setOpen] = useState(false);\n\n  return (\n    <div className=\"flex h-full flex-col bg-background no-scrollbar\">\n      <DepositHeader\n        title={title}\n        onBack={onBack}\n        countdown={countdown}\n        showClose={false}\n      />\n\n      <div className=\"flex-1 space-y-4 overflow-y-auto px-4 py-4\">\n        <div className=\"text-center py-2\">\n          {isSimulating ? (\n            <Skeleton className=\"h-10 w-32 mx-auto\" />\n          ) : (\n            <p className=\"text-4xl font-light text-foreground\">\n              ${amount.toFixed(6)}\n            </p>\n          )}\n          <div className=\"mt-2 inline-flex items-center gap-2 text-muted-foreground text-sm\">\n            <TokenIcon\n              symbol={details.receiveTokenSymbol}\n              tokenLogo={details.receiveTokenLogo}\n              size=\"sm\"\n            />\n            {isSimulating ? (\n              <Skeleton className=\"h-4 w-20\" />\n            ) : (\n              <span>{details.receiveAmountAfterSwap}</span>\n            )}\n          </div>\n        </div>\n\n        <InfoCard>\n          <InfoRow\n            label=\"You send\"\n            value={\n              <div className=\"flex items-center gap-2 py-1.5\">\n                {details.sources?.map((source, index) => (\n                  <TokenIcon\n                    key={source?.tokenAddress}\n                    symbol={source?.symbol}\n                    tokenLogo={source?.tokenLogo}\n                    chainLogo={source?.chainLogo}\n                    size=\"sm\"\n                    className={cn(\n                      \"last:mr-0\",\n                      index !== (details.sources?.length ?? 0) - 1 && \"-mr-3\"\n                    )}\n                  />\n                ))}\n                {isSimulating ? (\n                  <Skeleton className=\"h-4 w-24\" />\n                ) : (\n                  <span>{details.amountSpent}</span>\n                )}\n              </div>\n            }\n          />\n          <Separator className=\"my-2\" />\n          <InfoRow\n            label=\"You receive\"\n            value={\n              <div className=\"flex items-center gap-2 py-1.5\">\n                <TokenIcon\n                  symbol={details.receiveTokenSymbol}\n                  tokenLogo={details.receiveTokenLogo}\n                  size=\"sm\"\n                />\n                {isSimulating ? (\n                  <Skeleton className=\"h-4 w-20\" />\n                ) : (\n                  <span>{details.receiveAmountAfterSwap}</span>\n                )}\n              </div>\n            }\n          />\n          <Separator className=\"my-2\" />\n          <InfoRow\n            label=\"Estimated time\"\n            value={details.estimatedTime ?? \"Few seconds\"}\n            valueClassName=\"py-1.5\"\n          />\n        </InfoCard>\n\n        <Collapsible open={open} onOpenChange={setOpen}>\n          <CollapsibleTrigger className=\"flex w-full items-center justify-between py-3 text-sm text-muted-foreground hover:text-foreground transition-colors\">\n            <span>Transaction breakdown</span>\n            <ChevronRight\n              className={`h-4 w-4 transition-transform ${\n                open ? \"rotate-90\" : \"\"\n              }`}\n            />\n          </CollapsibleTrigger>\n          <CollapsibleContent>\n            <InfoCard className=\"space-y-0\">\n              <TooltipProvider>\n                <InfoRow\n                  label={\n                    <span className=\"flex items-center gap-1\">\n                      Network cost\n                      <Tooltip>\n                        <TooltipTrigger>\n                          <Info className=\"h-3 w-3\" />\n                        </TooltipTrigger>\n                        <TooltipContent>\n                          <p className=\"text-xs\">\n                            Gas fee required to complete the on-chain deposit\n                            transaction\n                          </p>\n                        </TooltipContent>\n                      </Tooltip>\n                    </span>\n                  }\n                  value={\n                    isSimulating ? (\n                      <Skeleton className=\"h-4 w-20\" />\n                    ) : (\n                      <span className=\"flex items-center gap-1\">\n                        <Fuel className=\"h-3.5 w-3.5 text-muted-foreground\" />\n                        {details.networkCost}\n                      </span>\n                    )\n                  }\n                />\n              </TooltipProvider>\n            </InfoCard>\n          </CollapsibleContent>\n        </Collapsible>\n      </div>\n\n      <div className=\"space-y-3 border-t border-border p-4 text-center text-xs text-muted-foreground\">\n        <p>\n          By clicking Confirm, you agree to our{\" \"}\n          <a\n            href=\"https://docs.availproject.org/terms\"\n            target=\"_blank\"\n            rel=\"noreferrer\"\n            className=\"text-foreground underline\"\n          >\n            terms\n          </a>{\" \"}\n          .\n        </p>\n        <Button\n          onClick={onConfirm}\n          disabled={isSimulating}\n          className=\"w-full rounded-xl text-base font-semibold\"\n        >\n          {isSimulating ? \"Refreshing quote\" : \"Confirm order\"}\n        </Button>\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component",
      "target": "components/swap-deposit/components/confirmation-step.tsx"
    },
    {
      "path": "registry/nexus-elements/swap-deposit/components/deposit-header.tsx",
      "content": "\"use client\";\n\nimport { Button } from \"../../ui/button\";\nimport { ChevronLeft, X } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface DepositHeaderProps {\n  title: string;\n  onBack?: () => void;\n  onClose?: () => void;\n  className?: string;\n  showBack?: boolean;\n  showClose?: boolean;\n  countdown?: number;\n  /** Total countdown duration for calculating progress (default: 15) */\n  countdownTotal?: number;\n}\n\ninterface CountdownRingProps {\n  countdown: number;\n  total: number;\n  size?: number;\n  strokeWidth?: number;\n}\n\nconst CountdownRing = ({\n  countdown,\n  total,\n  size = 36,\n  strokeWidth = 2,\n}: CountdownRingProps) => {\n  const radius = (size - strokeWidth) / 2;\n  const circumference = 2 * Math.PI * radius;\n  const progress = Math.max(0, Math.min(1, countdown / total));\n  const strokeDashoffset = circumference * (1 - progress);\n\n  return (\n    <div className=\"relative\" style={{ width: size, height: size }}>\n      <svg\n        width={size}\n        height={size}\n        className=\"-rotate-90\"\n        viewBox={`0 0 ${size} ${size}`}\n      >\n        {/* Background circle */}\n        <circle\n          cx={size / 2}\n          cy={size / 2}\n          r={radius}\n          fill=\"none\"\n          stroke=\"currentColor\"\n          strokeWidth={strokeWidth}\n          className=\"text-border\"\n        />\n        {/* Progress circle */}\n        <circle\n          cx={size / 2}\n          cy={size / 2}\n          r={radius}\n          fill=\"none\"\n          stroke=\"currentColor\"\n          strokeWidth={strokeWidth}\n          strokeLinecap=\"round\"\n          strokeDasharray={circumference}\n          strokeDashoffset={strokeDashoffset}\n          className=\"text-primary\"\n          style={{\n            transition: \"stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1)\",\n          }}\n        />\n      </svg>\n      {/* Countdown number */}\n      <div className=\"absolute inset-0 flex items-center justify-center\">\n        <span className=\"text-xs font-medium text-muted-foreground\">\n          {countdown}\n        </span>\n      </div>\n    </div>\n  );\n};\n\nexport const DepositHeader = ({\n  title,\n  onBack,\n  onClose,\n  className,\n  showBack = true,\n  showClose = false,\n  countdown,\n  countdownTotal = 15,\n}: DepositHeaderProps) => {\n  return (\n    <header\n      className={cn(\n        \"flex items-center justify-between px-4 py-3 border-b border-border\",\n        className\n      )}\n    >\n      <div className=\"w-10\">\n        {showBack && (\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            onClick={onBack}\n            className=\"text-foreground hover:bg-secondary\"\n          >\n            <ChevronLeft className=\"h-5 w-5\" />\n          </Button>\n        )}\n      </div>\n      <h1 className=\"text-base font-semibold text-foreground text-center flex-1\">\n        {title}\n      </h1>\n      <div className=\"w-10 flex justify-end\">\n        {showClose && (\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            onClick={onClose}\n            className=\"text-foreground hover:bg-secondary\"\n          >\n            <X className=\"h-4 w-4\" />\n          </Button>\n        )}\n        {countdown !== undefined && (\n          <CountdownRing countdown={countdown} total={countdownTotal} />\n        )}\n      </div>\n    </header>\n  );\n};\n",
      "type": "registry:component",
      "target": "components/swap-deposit/components/deposit-header.tsx"
    },
    {
      "path": "registry/nexus-elements/swap-deposit/components/info.tsx",
      "content": "\"use client\";\n\nimport type { ReactNode, PropsWithChildren } from \"react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface InfoCardProps extends PropsWithChildren {\n  className?: string;\n}\n\nexport const InfoCard = ({ className, children }: InfoCardProps) => {\n  return (\n    <div\n      className={cn(\n        \"rounded-xl border border-border bg-card px-4 py-1 shadow-sm\",\n        className\n      )}\n    >\n      {children}\n    </div>\n  );\n};\n\ninterface InfoRowProps {\n  label: ReactNode;\n  value: ReactNode;\n  className?: string;\n  labelClassName?: string;\n  valueClassName?: string;\n}\n\nexport const InfoRow = ({\n  label,\n  value,\n  className,\n  labelClassName,\n  valueClassName,\n}: InfoRowProps) => {\n  return (\n    <div\n      className={cn(\n        \"flex items-center justify-between py-0.5 leading-tight text-sm\",\n        className\n      )}\n    >\n      <span className={cn(\"text-muted-foreground\", labelClassName)}>\n        {label}\n      </span>\n      <span className={cn(\"text-foreground font-medium\", valueClassName)}>\n        {value}\n      </span>\n    </div>\n  );\n};\n",
      "type": "registry:component",
      "target": "components/swap-deposit/components/info.tsx"
    },
    {
      "path": "registry/nexus-elements/swap-deposit/components/step-indicator.tsx",
      "content": "\"use client\";\n\nimport { cn } from \"@/lib/utils\";\nimport { Check, Loader2 } from \"lucide-react\";\nimport { useEffect, useState } from \"react\";\n\ninterface StepIndicatorProps {\n  currentStep: 1 | 2;\n  stepComplete?: boolean;\n}\n\nconst STEPS = [\n  { id: 1, label: \"Swap\" },\n  { id: 2, label: \"Deposit\" },\n];\n\nexport const StepIndicator = ({\n  currentStep,\n  stepComplete = false,\n}: StepIndicatorProps) => {\n  const [isMerged, setIsMerged] = useState(false);\n  const allComplete = currentStep === 2 && stepComplete;\n\n  useEffect(() => {\n    if (allComplete) {\n      const timer = setTimeout(() => setIsMerged(true), 500);\n      return () => clearTimeout(timer);\n    } else {\n      setIsMerged(false);\n    }\n  }, [allComplete]);\n\n  return (\n    <div className=\"relative flex h-14 items-center justify-center w-full\">\n      <div\n        className={cn(\n          \"absolute inset-0 flex items-center justify-center transition-all duration-700 ease-in-out\",\n          isMerged\n            ? \"opacity-100 scale-100 translate-y-0\"\n            : \"opacity-0 scale-50 translate-y-4 pointer-events-none\"\n        )}\n      >\n        <div className=\"flex h-10 w-10 items-center justify-center rounded-full bg-success text-success-foreground shadow-[0_0_15px_rgba(34,197,94,0.4)] ring-2 ring-success/20\">\n          <Check\n            className=\"h-5 w-5 animate-in zoom-in duration-300\"\n            strokeWidth={3}\n          />\n        </div>\n      </div>\n\n      <div\n        className={cn(\n          \"flex items-center gap-3 transition-all duration-500 ease-in-out\",\n          isMerged\n            ? \"opacity-0 scale-90 blur-sm\"\n            : \"opacity-100 scale-100 blur-0\"\n        )}\n      >\n        {STEPS.map((step, index) => {\n          const isStepComplete =\n            step.id < currentStep || (step.id === currentStep && stepComplete);\n          const isStepActive = step.id === currentStep && !stepComplete;\n\n          return (\n            <div\n              key={step.id}\n              className=\"flex items-center gap-2 text-sm font-medium\"\n            >\n              <div\n                className={cn(\n                  \"relative flex h-8 w-8 items-center justify-center rounded-full border transition-all duration-300\",\n                  isStepComplete &&\n                    \"border-success bg-success text-success-foreground\",\n                  isStepActive &&\n                    \"border-primary text-primary ring-2 ring-primary/20\",\n                  !isStepComplete &&\n                    !isStepActive &&\n                    \"border-border text-muted-foreground\"\n                )}\n              >\n                <span className=\"absolute inset-0 flex items-center justify-center\">\n                  {isStepComplete && (\n                    <Check className=\"h-4 w-4 animate-in zoom-in duration-300\" />\n                  )}\n                  {isStepActive && <Loader2 className=\"h-4 w-4 animate-spin\" />}\n                  {!isStepComplete && !isStepActive && <span>{step.id}</span>}\n                </span>\n              </div>\n\n              <span\n                className={cn(\n                  \"transition-colors duration-300\",\n                  isStepComplete && \"text-success\",\n                  isStepActive && \"text-foreground\",\n                  !isStepComplete && !isStepActive && \"text-muted-foreground\"\n                )}\n              >\n                {step.label}\n              </span>\n              {index === 0 && (\n                <div className=\"mx-1 h-px w-8 bg-border overflow-hidden rounded-full\">\n                  <div\n                    className={cn(\n                      \"h-full bg-success transition-transform duration-500 ease-in-out origin-left\",\n                      currentStep > 1 || (currentStep === 1 && stepComplete)\n                        ? \"scale-x-100\"\n                        : \"scale-x-0\"\n                    )}\n                  />\n                </div>\n              )}\n            </div>\n          );\n        })}\n      </div>\n    </div>\n  );\n};\n",
      "type": "registry:component",
      "target": "components/swap-deposit/components/step-indicator.tsx"
    },
    {
      "path": "registry/nexus-elements/swap-deposit/components/token-icon.tsx",
      "content": "\"use client\";\n\nimport { cn } from \"@/lib/utils\";\n\ntype TokenIconSize = \"sm\" | \"md\" | \"lg\";\n\nconst SIZE_MAP: Record<TokenIconSize, number> = {\n  sm: 24,\n  md: 32,\n  lg: 40,\n};\n\ninterface TokenIconProps {\n  symbol?: string;\n  tokenLogo?: string;\n  chainLogo?: string;\n  size?: TokenIconSize;\n  className?: string;\n}\n\nexport const TokenIcon = ({\n  symbol,\n  tokenLogo,\n  chainLogo,\n  size = \"md\",\n  className,\n}: TokenIconProps) => {\n  const dimension = SIZE_MAP[size];\n\n  return (\n    <span className={cn(\"relative inline-flex\", className)}>\n      {tokenLogo ? (\n        <img\n          src={tokenLogo}\n          alt={symbol ?? \"token\"}\n          width={dimension}\n          height={dimension}\n          className=\"rounded-full object-cover\"\n        />\n      ) : (\n        <span\n          className={cn(\n            \"rounded-full bg-muted text-muted-foreground flex items-center justify-center font-semibold uppercase\",\n            {\n              \"h-6 w-6 text-xs\": size === \"sm\",\n              \"h-8 w-8 text-sm\": size === \"md\",\n              \"h-10 w-10 text-base\": size === \"lg\",\n            }\n          )}\n        >\n          {symbol?.slice(0, 2) ?? \"?\"}\n        </span>\n      )}\n      {chainLogo && (\n        <span className=\"absolute -bottom-0.5 -right-0.5 rounded-full border border-background bg-background\">\n          <img\n            src={chainLogo}\n            alt=\"chain logo\"\n            width={Math.max(14, dimension * 0.4)}\n            height={Math.max(14, dimension * 0.4)}\n            className=\"rounded-full object-cover\"\n          />\n        </span>\n      )}\n    </span>\n  );\n};\n",
      "type": "registry:component",
      "target": "components/swap-deposit/components/token-icon.tsx"
    },
    {
      "path": "registry/nexus-elements/swap-deposit/components/transaction-status-step.tsx",
      "content": "\"use client\";\n\nimport { useState } from \"react\";\nimport { DepositHeader } from \"./deposit-header\";\nimport { StepIndicator } from \"./step-indicator\";\nimport { TokenIcon } from \"./token-icon\";\nimport { InfoRow, InfoCard } from \"./info\";\nimport { Button } from \"../../ui/button\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/registry/nexus-elements/ui/collapsible\";\nimport { ChevronRight, ExternalLink, Loader2 } from \"lucide-react\";\nimport { type AssetSelection } from \"./asset-select\";\nimport { type TransactionStatus } from \"../hooks/useSwapDeposit\";\nimport { cn } from \"@/lib/utils\";\n\ninterface DepositStatusDetails {\n  sourceLabel: string;\n  sources?: (AssetSelection | undefined)[];\n  gasTokenSymbol?: string;\n  networkCost?: number;\n  priceImpact?: number;\n  successTitle?: string;\n}\n\ninterface TransactionStatusStepProps {\n  details: DepositStatusDetails;\n  receiveAmount: string;\n  status: TransactionStatus;\n  tokenLogo: string;\n  totalTime?: string;\n  onClose: () => void;\n  onNewDeposit: () => void;\n  explorerUrls: {\n    source: string | null;\n    destination: string | null;\n    depositUrl: string | null;\n  };\n}\n\nconst TransactionStatusStep = ({\n  details,\n  receiveAmount,\n  onClose,\n  onNewDeposit,\n  status,\n  tokenLogo,\n  totalTime,\n  explorerUrls,\n}: TransactionStatusStepProps) => {\n  const [open, setOpen] = useState(false);\n  const isSuccessView = status === \"success\";\n  const headerTitle = isSuccessView\n    ? details.successTitle ?? details.sourceLabel\n    : details.sourceLabel;\n  const processingTitle =\n    status === \"swapping\"\n      ? \"Submitting transaction...\"\n      : \"Depositing into your account...\";\n  const processingSubtitle =\n    status === \"swapping\"\n      ? \"Filling your transaction on the blockchain.\"\n      : \"It will take a few seconds to finalize.\";\n  const title = isSuccessView ? \"Deposit successful\" : processingTitle;\n  const subtitle = isSuccessView\n    ? \"Your funds were successfully deposited.\"\n    : processingSubtitle;\n  const isSwap = status === \"swapping\";\n  const currentStep = isSwap ? 1 : 2;\n\n  return (\n    <div className=\"flex h-full flex-col bg-background no-scrollbar\">\n      <DepositHeader\n        title={headerTitle || \"Deposit\"}\n        onClose={onClose}\n        showBack={false}\n        showClose\n      />\n\n      <div className=\"flex-1 space-y-4 overflow-y-auto px-4 py-4\">\n        <StepIndicator currentStep={currentStep} stepComplete={isSuccessView} />\n        <div className=\"text-center space-y-2\">\n          <h2 className=\"text-lg font-semibold text-foreground\">{title}</h2>\n          <p className=\"text-sm text-muted-foreground\">{subtitle}</p>\n        </div>\n\n        <InfoCard>\n          <InfoRow\n            label=\"Fill status\"\n            value={\n              isSuccessView ? (\n                <span className=\"text-success font-semibold\">Successful</span>\n              ) : (\n                \"Processing\"\n              )\n            }\n          />\n          {isSuccessView && (\n            <InfoRow label=\"Total time\" value={totalTime ?? \"—\"} />\n          )}\n        </InfoCard>\n\n        {isSuccessView ? (\n          <InfoCard>\n            {explorerUrls?.source && (\n              <InfoRow\n                label=\"Source Swap Hash\"\n                value={\n                  <div className=\"flex items-center gap-2\">\n                    <a href={explorerUrls.source} target=\"_blank\">\n                      <ExternalLink className=\"h-3.5 w-3.5 text-muted-foreground\" />\n                    </a>\n                  </div>\n                }\n              />\n            )}\n\n            {explorerUrls?.destination && (\n              <InfoRow\n                label=\"Destination Swap Hash\"\n                value={\n                  <div className=\"flex items-center gap-2\">\n                    <a href={explorerUrls.destination} target=\"_blank\">\n                      <ExternalLink className=\"h-3.5 w-3.5 text-muted-foreground\" />\n                    </a>\n                  </div>\n                }\n              />\n            )}\n            {explorerUrls?.depositUrl && (\n              <InfoRow\n                label=\"Deposit Hash\"\n                value={\n                  <div className=\"flex items-center gap-2\">\n                    <a href={explorerUrls.depositUrl} target=\"_blank\">\n                      <ExternalLink className=\"h-3.5 w-3.5 text-muted-foreground\" />\n                    </a>\n                  </div>\n                }\n              />\n            )}\n          </InfoCard>\n        ) : (\n          <InfoCard>\n            <InfoRow\n              label=\"Sources\"\n              value={\n                <div className=\"flex items-center gap-2\">\n                  {details.sources?.map((source, index) => (\n                    <TokenIcon\n                      key={\n                        source?.tokenAddress ??\n                        source?.symbol ??\n                        `source-${index}`\n                      }\n                      symbol={source?.symbol}\n                      tokenLogo={source?.tokenLogo}\n                      chainLogo={source?.chainLogo}\n                      size=\"sm\"\n                      className={cn(\n                        \"last:mr-0\",\n                        index !== (details.sources?.length ?? 0) - 1 && \"-mr-3\"\n                      )}\n                    />\n                  ))}\n                  <span>{details.sourceLabel}</span>\n                  {explorerUrls?.source && (\n                    <a href={explorerUrls.source} target=\"_blank\">\n                      <ExternalLink className=\"h-3.5 w-3.5 text-muted-foreground\" />\n                    </a>\n                  )}\n                </div>\n              }\n            />\n            {explorerUrls?.destination && (\n              <InfoRow\n                label=\"Destination Swap Hash\"\n                value={\n                  <div className=\"flex items-center gap-2\">\n                    <a href={explorerUrls.destination} target=\"_blank\">\n                      <ExternalLink className=\"h-3.5 w-3.5 text-muted-foreground\" />\n                    </a>\n                  </div>\n                }\n              />\n            )}\n          </InfoCard>\n        )}\n\n        <InfoCard>\n          <InfoRow\n            label={isSuccessView ? \"You received\" : \"You receive\"}\n            value={\n              <div className=\"flex items-center gap-2\">\n                <TokenIcon symbol={tokenLogo} size=\"sm\" />\n                <span>{receiveAmount}</span>\n              </div>\n            }\n          />\n        </InfoCard>\n\n        <Collapsible open={open} onOpenChange={setOpen}>\n          <CollapsibleTrigger className=\"flex w-full items-center justify-between py-3 text-sm text-muted-foreground transition-colors hover:text-foreground\">\n            <span>More details</span>\n            <ChevronRight\n              className={`h-4 w-4 transition-transform ${\n                open ? \"rotate-90\" : \"\"\n              }`}\n            />\n          </CollapsibleTrigger>\n          <CollapsibleContent>\n            <InfoCard className=\"space-y-0\">\n              <InfoRow\n                label=\"Network cost\"\n                value={\n                  typeof details?.networkCost === \"number\"\n                    ? `$${details.networkCost}`\n                    : \"—\"\n                }\n              />\n            </InfoCard>\n          </CollapsibleContent>\n        </Collapsible>\n      </div>\n\n      <div className=\"flex gap-3 border-t border-border p-4\">\n        <Button\n          variant=\"secondary\"\n          onClick={onClose}\n          className=\"flex-1 rounded-xl text-base\"\n        >\n          Close\n        </Button>\n        <Button\n          onClick={onNewDeposit}\n          className=\"flex-1 rounded-xl text-base\"\n          disabled={!isSuccessView}\n        >\n          {isSuccessView ? (\n            \"New Deposit\"\n          ) : (\n            <Loader2 className=\"size-5 animate-spin\" />\n          )}\n        </Button>\n      </div>\n    </div>\n  );\n};\n\nexport default TransactionStatusStep;\n",
      "type": "registry:component",
      "target": "components/swap-deposit/components/transaction-status-step.tsx"
    },
    {
      "path": "registry/nexus-elements/swap-deposit/hooks/useSwapDeposit.ts",
      "content": "import {\n  NEXUS_EVENTS,\n  type OnSwapIntentHookData,\n  type SwapStepType,\n  type ExactInSwapInput,\n  type ExecuteParams,\n  type ExecuteSimulation,\n  type SUPPORTED_CHAINS_IDS,\n  CHAIN_METADATA,\n  parseUnits,\n} from \"@avail-project/nexus-core\";\nimport {\n  useCallback,\n  useEffect,\n  useMemo,\n  useReducer,\n  useRef,\n  useState,\n} from \"react\";\nimport {\n  SWAP_EXPECTED_STEPS,\n  useNexusError,\n  usePolling,\n  useStopwatch,\n  useTransactionSteps,\n} from \"../../common\";\nimport { type Address } from \"viem\";\nimport { useAccount } from \"wagmi\";\nimport { useNexus } from \"../../nexus/NexusProvider\";\nimport { type AssetSelection } from \"../components/asset-select\";\n\nexport type TransactionStatus =\n  | \"idle\"\n  | \"set-source-assets\"\n  | \"set-amount\"\n  | \"view-breakdown\"\n  | \"swapping\"\n  | \"depositing\"\n  | \"success\"\n  | \"error\";\n\ninterface SwapInputs extends ExactInSwapInput {\n  toTokenSymbol: string;\n}\n\ninterface DestinationConfig {\n  chainId: SUPPORTED_CHAINS_IDS;\n  tokenAddress: `0x${string}`;\n  tokenSymbol: string;\n  tokenDecimals: number;\n  tokenLogo?: string;\n  label?: string;\n  estimatedTime?: string;\n  gasTokenSymbol?: string;\n}\n\ntype SwapDepositState = {\n  inputs: SwapInputs | null;\n  selectedSources: AssetSelection[];\n  status: TransactionStatus;\n  error: string | null;\n  simulation: {\n    executeSimulation: ExecuteSimulation;\n    swapIntent: OnSwapIntentHookData;\n  } | null;\n  explorerUrls: {\n    source: string | null;\n    destination: string | null;\n    depositUrl: string | null;\n  };\n  simulationLoading: boolean;\n  receiveAmount: string | null;\n};\n\ninterface UseSwapDepositProps {\n  executeDeposit: (\n    tokenSymbol: string,\n    tokenAddress: string,\n    amount: bigint,\n    chainId: number,\n    user: Address\n  ) => Omit<ExecuteParams, \"toChainId\">;\n  destination: DestinationConfig;\n  onSwapComplete?: (amount?: string, explorerURL?: string) => void;\n  onDepositComplete?: (explorerURL?: string) => void;\n  onStart?: () => void;\n  onError?: (message: string) => void;\n}\n\ntype Action =\n  | { type: \"setInputs\"; payload: Partial<SwapInputs> }\n  | { type: \"setSelectedSources\"; payload: AssetSelection[] }\n  | {\n      type: \"setSimulation\";\n      payload: {\n        executeSimulation: ExecuteSimulation;\n        swapIntent: OnSwapIntentHookData;\n      };\n    }\n  | { type: \"setStatus\"; payload: TransactionStatus }\n  | { type: \"setError\"; payload: string | null }\n  | { type: \"setSimulationLoading\"; payload: boolean }\n  | { type: \"setReceiveAmount\"; payload: string | null }\n  | {\n      type: \"setExplorerUrls\";\n      payload: Partial<SwapDepositState[\"explorerUrls\"]>;\n    }\n  | { type: \"reset\" };\n\nconst initialState: SwapDepositState = {\n  inputs: null,\n  selectedSources: [],\n  status: \"idle\",\n  error: null,\n  simulation: null,\n  explorerUrls: {\n    source: null,\n    destination: null,\n    depositUrl: null,\n  },\n  simulationLoading: false,\n  receiveAmount: null,\n};\n\nfunction reducer(state: SwapDepositState, action: Action): SwapDepositState {\n  switch (action.type) {\n    case \"setInputs\": {\n      const merged = state.inputs\n        ? { ...state.inputs, ...action.payload }\n        : { ...action.payload };\n      if (\n        merged.from !== undefined &&\n        merged.toChainId !== undefined &&\n        merged.toTokenAddress !== undefined\n      ) {\n        let newStatus = state.status;\n        const hasSourceAssets =\n          merged.from !== undefined && merged.from.length > 0;\n        const hasAmount =\n          merged.from?.[0]?.amount !== undefined &&\n          merged.from?.[0]?.amount > BigInt(0);\n\n        if (!hasSourceAssets) {\n          newStatus = \"idle\";\n        } else if (hasSourceAssets && !hasAmount) {\n          newStatus = \"set-source-assets\";\n        } else if (hasSourceAssets && hasAmount) {\n          newStatus = \"set-amount\";\n        }\n        console.log(\"setInputs\", {\n          ...state,\n          inputs: merged as SwapInputs,\n          status: newStatus,\n          error: null,\n        });\n        return {\n          ...state,\n          inputs: merged as SwapInputs,\n          status: newStatus,\n          error: null,\n        };\n      }\n      return state;\n    }\n    case \"setSelectedSources\":\n      return { ...state, selectedSources: action.payload };\n    case \"setSimulation\":\n      return {\n        ...state,\n        simulation: action.payload,\n      };\n    case \"setStatus\":\n      return { ...state, status: action.payload };\n    case \"setError\":\n      return { ...state, error: action.payload };\n    case \"setExplorerUrls\":\n      return {\n        ...state,\n        explorerUrls: { ...state.explorerUrls, ...action.payload },\n      };\n    case \"setSimulationLoading\":\n      return { ...state, simulationLoading: action.payload };\n    case \"setReceiveAmount\":\n      return { ...state, receiveAmount: action.payload };\n    case \"reset\":\n      return { ...initialState };\n    default:\n      return state;\n  }\n}\n\nconst useSwapDeposit = ({\n  executeDeposit,\n  destination,\n  onSwapComplete,\n  onDepositComplete,\n  onStart,\n  onError,\n}: UseSwapDepositProps) => {\n  const {\n    nexusSDK,\n    swapIntent,\n    swapBalance,\n    fetchSwapBalance,\n    getFiatValue,\n    exchangeRate,\n  } = useNexus();\n\n  const [state, dispatch] = useReducer(reducer, initialState);\n  const [pollingEnabled, setPollingEnabled] = useState(false);\n  const { address } = useAccount();\n  const loading = state.status === \"swapping\" || state.status === \"depositing\";\n  const handleNexusError = useNexusError();\n\n  const {\n    seed,\n    onStepComplete,\n    reset: resetSteps,\n  } = useTransactionSteps<SwapStepType>();\n\n  const stopwatch = useStopwatch({\n    running:\n      state.status === \"swapping\" ||\n      state.status === \"depositing\" ||\n      (state.status === \"view-breakdown\" && !state.simulationLoading),\n    intervalMs: 100,\n  });\n\n  const hasAutoSelected = useRef(false);\n  const initialSimulationDone = useRef(false);\n  const lastSimulationTime = useRef(0);\n\n  const availableAssets = useMemo(() => {\n    if (!swapBalance) return [];\n    const items: AssetSelection[] = [];\n\n    for (const asset of swapBalance) {\n      if (!asset?.breakdown?.length) continue;\n      for (const breakdown of asset.breakdown) {\n        if (!breakdown?.chain?.id || !breakdown.balance) continue;\n        const numericBalance = Number.parseFloat(breakdown.balance);\n        if (!Number.isFinite(numericBalance) || numericBalance <= 0) continue;\n\n        items.push({\n          chainId: breakdown.chain.id,\n          tokenAddress: breakdown.contractAddress,\n          decimals: breakdown.decimals ?? asset.decimals,\n          symbol: asset.symbol,\n          balance: breakdown.balance,\n          balanceInFiat: breakdown.balanceInFiat,\n          tokenLogo: asset.icon,\n          chainLogo: breakdown.chain.logo,\n          chainName: breakdown.chain.name,\n        });\n      }\n    }\n    return items.toSorted((a, b) => b.balanceInFiat - a.balanceInFiat);\n  }, [swapBalance]);\n\n  const activeIntent = state.simulation?.swapIntent ?? swapIntent.current;\n\n  const confirmationDetails = useMemo(() => {\n    if (!activeIntent || !nexusSDK) return null;\n    const receiveAmountAfterSwap = nexusSDK.utils.formatTokenBalance(\n      activeIntent.intent.destination.amount,\n      {\n        symbol: activeIntent.intent.destination.token.symbol,\n        decimals: activeIntent.intent.destination.token.decimals,\n      }\n    );\n\n    const receiveAmountAfterSwapUsd = getFiatValue(\n      Number.parseFloat(activeIntent.intent.destination.amount),\n      destination.tokenSymbol\n    );\n\n    const totalAmountSpent = nexusSDK?.utils?.formatTokenBalance(\n      activeIntent.intent.sources?.reduce((acc, source) => {\n        const amount = Number.parseFloat(source.amount);\n        return acc + amount;\n      }, 0),\n      {\n        symbol: destination.tokenSymbol,\n        decimals: destination.tokenDecimals,\n      }\n    );\n\n    const sources = activeIntent.intent.sources.map((source) =>\n      availableAssets.find(\n        (asset) =>\n          asset.chainId === source.chain.id &&\n          asset.symbol === source.token.symbol\n      )\n    );\n\n    return {\n      sourceLabel: destination.label,\n      sources,\n      gasTokenSymbol: destination.gasTokenSymbol,\n      estimatedTime: destination.estimatedTime ?? \"≈ 30s\",\n      amountSpent: totalAmountSpent,\n      receiveTokenSymbol: destination.tokenSymbol,\n      receiveAmountAfterSwapUsd,\n      receiveAmountAfterSwap,\n      receiveTokenLogo: destination.tokenLogo,\n      receiveTokenChain: destination.chainId,\n    };\n  }, [activeIntent, nexusSDK, destination]);\n\n  const feeBreakdown = useMemo(() => {\n    if (!nexusSDK || !state.simulation || !state.inputs)\n      return { totalGasFee: 0, gasUsd: 0, gasFormatted: \"0\" };\n\n    const native = CHAIN_METADATA[state.inputs.toChainId]?.nativeCurrency;\n    const nativeSymbol = native?.symbol;\n    const nativeDecimals = native?.decimals;\n\n    const gasFormatted =\n      nexusSDK?.utils?.formatTokenBalance(\n        state.simulation.executeSimulation?.gasFee,\n        { symbol: nativeSymbol, decimals: nativeDecimals }\n      ) ?? \"0\";\n    const gasUnits = Number.parseFloat(\n      nexusSDK?.utils?.formatUnits(\n        state.simulation.executeSimulation?.gasFee,\n        nativeDecimals\n      )\n    );\n    const gasUsd = getFiatValue(gasUnits, nativeSymbol);\n\n    return { totalGasFee: gasUsd, gasUsd, gasFormatted };\n  }, [nexusSDK, getFiatValue, state.simulation, state.inputs]);\n\n  const totalSelectedBalance = useMemo(\n    () =>\n      state.selectedSources.reduce(\n        (sum, source) => sum + source.balanceInFiat,\n        0\n      ),\n    [state.selectedSources, getFiatValue]\n  );\n\n  const handleDeposit = (amount: bigint) => {\n    if (!nexusSDK || !address) return;\n    const executeParams = executeDeposit(\n      destination.tokenSymbol,\n      destination.tokenAddress,\n      amount,\n      destination.chainId,\n      address\n    );\n\n    nexusSDK\n      .execute({\n        ...executeParams,\n        toChainId: destination.chainId,\n      })\n      .then((depositResult) => {\n        if (!depositResult) {\n          throw new Error(\"Deposit failed\");\n        }\n        dispatch({\n          type: \"setExplorerUrls\",\n          payload: { depositUrl: depositResult.explorerUrl },\n        });\n        onDepositComplete?.(depositResult.explorerUrl);\n        return fetchSwapBalance();\n      })\n      .then(() => {\n        dispatch({ type: \"setStatus\", payload: \"success\" });\n      })\n      .catch((error) => {\n        const { message } = handleNexusError(error);\n        dispatch({ type: \"setError\", payload: message });\n        dispatch({ type: \"setStatus\", payload: \"error\" });\n        onError?.(message);\n      });\n  };\n\n  const initiateSwapIntent = (inputs: SwapInputs) => {\n    if (!nexusSDK || !inputs || loading) return;\n    onStart?.();\n    seed(SWAP_EXPECTED_STEPS);\n    nexusSDK\n      .swapWithExactIn(inputs, {\n        onEvent: (event) => {\n          if (event.name === NEXUS_EVENTS.SWAP_STEP_COMPLETE) {\n            const step = event.args as SwapStepType & {\n              explorerURL?: string;\n              completed?: boolean;\n            };\n            if (step?.type === \"SOURCE_SWAP_HASH\" && step.explorerURL) {\n              dispatch({\n                type: \"setExplorerUrls\",\n                payload: { source: step.explorerURL },\n              });\n            }\n            if (step?.type === \"DESTINATION_SWAP_HASH\" && step.explorerURL) {\n              dispatch({\n                type: \"setExplorerUrls\",\n                payload: { destination: step.explorerURL },\n              });\n            }\n            onStepComplete(step);\n          }\n        },\n      })\n      .then((swapResult) => {\n        if (!swapResult?.success) {\n          throw new Error(swapResult?.error || \"Swap failed\");\n        }\n\n        console.log(\"swap complete\", swapResult, swapIntent.current?.intent);\n        if (swapResult) {\n          const formattedAmount = nexusSDK.utils.parseUnits(\n            swapIntent.current?.intent?.destination?.amount ?? \"0\",\n            swapIntent.current?.intent?.destination?.token?.decimals ??\n              destination.tokenDecimals\n          );\n          dispatch({\n            type: \"setReceiveAmount\",\n            payload: swapIntent.current?.intent?.destination?.amount ?? \"\",\n          });\n          onSwapComplete?.(\n            swapIntent.current?.intent?.destination?.amount,\n            swapResult.result.explorerURL\n          );\n          dispatch({ type: \"setStatus\", payload: \"depositing\" });\n          handleDeposit(formattedAmount);\n        }\n      })\n      .catch((error) => {\n        const { message } = handleNexusError(error);\n        dispatch({ type: \"setError\", payload: message });\n        dispatch({ type: \"setStatus\", payload: \"error\" });\n        onError?.(message);\n      })\n      .finally(() => {\n        swapIntent.current = null;\n      });\n  };\n\n  const simulateDeposit = async (): Promise<boolean> => {\n    if (\n      !nexusSDK ||\n      !state.inputs ||\n      loading ||\n      !address ||\n      !swapIntent.current\n    )\n      return false;\n\n    try {\n      const executeParams = executeDeposit(\n        state.inputs.toTokenSymbol,\n        state.inputs.toTokenAddress,\n        nexusSDK.utils.parseUnits(\n          swapIntent.current?.intent.destination.amount,\n          swapIntent.current?.intent?.destination?.token?.decimals\n        ),\n        state.inputs.toChainId,\n        address\n      );\n      const simulateDepositResult = await nexusSDK.simulateBridgeAndExecute({\n        token: destination.tokenSymbol,\n        amount: nexusSDK.utils.parseUnits(\n          swapIntent.current?.intent.destination.amount,\n          swapIntent.current?.intent?.destination?.token?.decimals\n        ),\n        toChainId: destination.chainId,\n        execute: executeParams,\n        sourceChains: state.inputs.from.map((asset) => asset.chainId),\n      });\n\n      console.log(\"simulateDepositResult\", simulateDepositResult);\n\n      if (!simulateDepositResult) {\n        throw new Error(\"Simulation failed\");\n      }\n      dispatch({\n        type: \"setSimulation\",\n        payload: {\n          executeSimulation: simulateDepositResult?.executeSimulation,\n          swapIntent: swapIntent.current,\n        },\n      });\n      return true;\n    } catch (error) {\n      const { message } = handleNexusError(error);\n      dispatch({ type: \"setError\", payload: message });\n      dispatch({ type: \"setStatus\", payload: \"error\" });\n      onError?.(message);\n      return false;\n    }\n  };\n\n  const handleToggleSource = useCallback(\n    (source: AssetSelection) => {\n      const sourceId = `${source.symbol}-${source.chainId}-${source.tokenAddress}`;\n      const isSelected = state.selectedSources.some(\n        (s) => `${s.symbol}-${s.chainId}-${s.tokenAddress}` === sourceId\n      );\n\n      if (isSelected) {\n        dispatch({\n          type: \"setSelectedSources\",\n          // payload: state.selectedSources.filter(\n          //   (s) => `${s.symbol}-${s.chainId}-${s.tokenAddress}` !== sourceId\n          // ),\n          payload: [],\n        });\n        return;\n      }\n      dispatch({\n        type: \"setSelectedSources\",\n        // payload: [...state.selectedSources, source],\n        payload: [source],\n      });\n    },\n    [state.selectedSources]\n  );\n\n  const handleSourcesContinue = useCallback(() => {\n    if (!nexusSDK || state.selectedSources.length === 0) return;\n\n    dispatch({ type: \"setError\", payload: null });\n    const sortedSources = [...state.selectedSources].sort(\n      (a, b) => Number.parseFloat(b.balance) - Number.parseFloat(a.balance)\n    );\n\n    const fromArray = sortedSources.map((source) => ({\n      chainId: source.chainId as SUPPORTED_CHAINS_IDS,\n      tokenAddress: source.tokenAddress,\n      amount: BigInt(0),\n    }));\n\n    dispatch({\n      type: \"setInputs\",\n      payload: {\n        from: fromArray,\n        toChainId: destination.chainId,\n        toTokenAddress: destination.tokenAddress,\n        toTokenSymbol: destination.tokenSymbol,\n      },\n    });\n  }, [nexusSDK, state.selectedSources, destination]);\n\n  const handleMultiSourceAmount = useCallback(\n    (totalAmountUsd: number) => {\n      if (!nexusSDK || state.selectedSources.length === 0) return;\n      const MAX_USAGE_RATIO = 0.95;\n      const sourcesWithUsd = state.selectedSources.map((source) => ({\n        ...source,\n        tokenBalance: Number.parseFloat(source.balance),\n        usdValue: source.balanceInFiat,\n        maxUsableUsd: source.balanceInFiat * MAX_USAGE_RATIO,\n      }));\n\n      const sortedSources = sourcesWithUsd.toSorted(\n        (a, b) => b.usdValue - a.usdValue\n      );\n\n      const totalUsdBalance = sortedSources.reduce(\n        (sum, s) => sum + s.usdValue,\n        0\n      );\n\n      const allocations = sortedSources.map((source) => {\n        const proportion = source.usdValue / totalUsdBalance;\n        const idealAllocation = totalAmountUsd * proportion;\n        const cappedAllocation = Math.min(idealAllocation, source.maxUsableUsd);\n\n        return {\n          source,\n          allocation: cappedAllocation,\n          excessAmount: Math.max(0, idealAllocation - source.maxUsableUsd),\n        };\n      });\n\n      let remainingToAllocate = allocations.reduce(\n        (sum, a) => sum + a.excessAmount,\n        0\n      );\n      const MAX_ITERATIONS = 10;\n      let iteration = 0;\n\n      while (remainingToAllocate > 0.01 && iteration < MAX_ITERATIONS) {\n        iteration++;\n\n        const sourcesWithHeadroom = allocations.filter(\n          (a) => a.allocation < a.source.maxUsableUsd\n        );\n\n        if (sourcesWithHeadroom.length === 0) break;\n        const totalHeadroom = sourcesWithHeadroom.reduce(\n          (sum, a) => sum + (a.source.maxUsableUsd - a.allocation),\n          0\n        );\n\n        if (totalHeadroom <= 0) break;\n\n        const toDistribute = Math.min(remainingToAllocate, totalHeadroom);\n        for (const alloc of sourcesWithHeadroom) {\n          const headroom = alloc.source.maxUsableUsd - alloc.allocation;\n          const share = headroom / totalHeadroom;\n          const additional = toDistribute * share;\n          alloc.allocation = Math.min(\n            alloc.allocation + additional,\n            alloc.source.maxUsableUsd\n          );\n        }\n\n        remainingToAllocate = Math.max(0, remainingToAllocate - toDistribute);\n      }\n\n      const fromArray = allocations\n        .filter(({ allocation }) => allocation > 0.001)\n        .map(({ source, allocation }) => {\n          const rate = exchangeRate?.[source.symbol.toUpperCase()] ?? 1;\n          const tokenAmount = rate > 0 ? allocation / rate : 0;\n\n          const parsed = nexusSDK.utils.parseUnits(\n            tokenAmount.toString(),\n            source.decimals\n          );\n\n          return {\n            chainId: source.chainId as SUPPORTED_CHAINS_IDS,\n            tokenAddress: source.tokenAddress,\n            amount: parsed,\n          };\n        })\n        .filter((item) => item.amount > BigInt(0));\n\n      if (fromArray.length === 0) {\n        dispatch({\n          type: \"setError\",\n          payload: \"Unable to allocate amount across selected sources\",\n        });\n        return;\n      }\n\n      const newInputs: SwapInputs = {\n        from: fromArray,\n        toChainId: destination.chainId,\n        toTokenAddress: destination.tokenAddress,\n        toTokenSymbol: destination.tokenSymbol,\n      };\n\n      dispatch({ type: \"setInputs\", payload: newInputs });\n      dispatch({ type: \"setStatus\", payload: \"view-breakdown\" });\n      dispatch({ type: \"setSimulationLoading\", payload: true });\n      initiateSwapIntent(newInputs);\n    },\n    [nexusSDK, state.selectedSources, destination, exchangeRate]\n  );\n\n  const handleSingleSourceAmount = useCallback(\n    (totalAmountUsd: number) => {\n      if (!nexusSDK || state.selectedSources.length === 0 || !exchangeRate)\n        return;\n      const source = state.selectedSources[0];\n      const tokenAmount = totalAmountUsd / exchangeRate[source.symbol];\n      const tokenAmountStr = tokenAmount.toFixed(source.decimals);\n      const parsed = parseUnits(tokenAmountStr, source.decimals);\n      console.log(\"% SEND AMOUNT\", {\n        totalAmountUsd,\n        tokenAmount,\n        exchangeRate: exchangeRate[source.symbol],\n        decimals: source.decimals,\n        symbol: source.symbol,\n        parsed,\n      });\n      const newInputs: SwapInputs = {\n        from: [\n          {\n            amount: parsed,\n            tokenAddress: source.tokenAddress,\n            chainId: source.chainId,\n          },\n        ],\n        toChainId: destination.chainId,\n        toTokenAddress: destination.tokenAddress,\n        toTokenSymbol: destination.tokenSymbol,\n      };\n      dispatch({ type: \"setInputs\", payload: newInputs });\n      dispatch({ type: \"setStatus\", payload: \"view-breakdown\" });\n      dispatch({ type: \"setSimulationLoading\", payload: true });\n      initiateSwapIntent(newInputs);\n    },\n    [\n      nexusSDK,\n      state.selectedSources,\n      destination,\n      initiateSwapIntent,\n      exchangeRate,\n    ]\n  );\n\n  const handleAmountContinue = useCallback(\n    (totalAmountUsd: number) => {\n      if (!nexusSDK || state.selectedSources.length === 0) return;\n      handleSingleSourceAmount(totalAmountUsd);\n    },\n    [nexusSDK, state.selectedSources, handleSingleSourceAmount]\n  );\n\n  const handleConfirmOrder = useCallback(() => {\n    if (!swapIntent.current) return;\n    dispatch({ type: \"setStatus\", payload: \"swapping\" });\n    swapIntent.current.allow();\n  }, [swapIntent]);\n\n  const handleBack = useCallback(() => {\n    if (swapIntent.current) {\n      swapIntent.current.deny();\n    }\n    dispatch({ type: \"reset\" });\n    resetSteps();\n    initialSimulationDone.current = false;\n    lastSimulationTime.current = 0;\n    setPollingEnabled(false);\n    stopwatch.stop();\n    stopwatch.reset();\n  }, [swapIntent, resetSteps, stopwatch]);\n\n  const reset = useCallback(() => {\n    dispatch({ type: \"reset\" });\n    resetSteps();\n    swapIntent.current = null;\n    initialSimulationDone.current = false;\n    lastSimulationTime.current = 0;\n    setPollingEnabled(false);\n    stopwatch.stop();\n    stopwatch.reset();\n  }, [resetSteps, swapIntent, stopwatch]);\n\n  const refreshSimulation = async () => {\n    // Skip if last simulation was less than 5 seconds ago (prevents immediate fire after initial)\n    const timeSinceLastSimulation = Date.now() - lastSimulationTime.current;\n    if (timeSinceLastSimulation < 5000) {\n      return;\n    }\n\n    try {\n      dispatch({ type: \"setSimulationLoading\", payload: true });\n      const updated = await swapIntent.current?.refresh();\n      if (updated) {\n        swapIntent.current!.intent = updated;\n      }\n      await simulateDeposit();\n    } catch (e) {\n      console.error(e);\n    } finally {\n      dispatch({ type: \"setSimulationLoading\", payload: false });\n      stopwatch.reset();\n      lastSimulationTime.current = Date.now();\n    }\n  };\n\n  // Poll for swapIntent to be available for initial simulation only\n  useEffect(() => {\n    // Only run when we're waiting for initial simulation\n    if (\n      initialSimulationDone.current ||\n      !state.simulationLoading ||\n      state.status !== \"view-breakdown\"\n    ) {\n      return;\n    }\n\n    const checkInterval = setInterval(() => {\n      if (swapIntent.current && !initialSimulationDone.current) {\n        clearInterval(checkInterval);\n        initialSimulationDone.current = true;\n        void simulateDeposit().then(() => {\n          dispatch({ type: \"setSimulationLoading\", payload: false });\n          stopwatch.reset();\n          lastSimulationTime.current = Date.now();\n          setPollingEnabled(true);\n        });\n      }\n    }, 100);\n\n    return () => clearInterval(checkInterval);\n  }, [state.simulationLoading, state.status]);\n\n  useEffect(() => {\n    if (!nexusSDK) return;\n\n    if (!swapBalance) {\n      void fetchSwapBalance();\n      return;\n    }\n\n    if (!hasAutoSelected.current && availableAssets.length > 0) {\n      hasAutoSelected.current = true;\n      dispatch({\n        type: \"setSelectedSources\",\n        payload: [availableAssets[0]],\n      });\n    }\n  }, [nexusSDK, swapBalance, availableAssets, fetchSwapBalance]);\n\n  usePolling(\n    pollingEnabled &&\n      state.status === \"view-breakdown\" &&\n      Boolean(swapIntent.current) &&\n      !state.simulationLoading,\n    async () => {\n      await refreshSimulation();\n    },\n    15000\n  );\n\n  return {\n    // State\n    status: state.status,\n    loading,\n    txError: state.error,\n    simulationLoading: state.simulationLoading,\n    timer: stopwatch.seconds,\n    explorerUrls: state.explorerUrls,\n\n    // Data from NexusProvider (for AssetSelect)\n    swapBalance,\n    availableAssets,\n\n    // Selected sources\n    selectedSources: state.selectedSources,\n    totalSelectedBalance,\n\n    // Computed data\n    activeIntent,\n    confirmationDetails,\n    feeBreakdown,\n    destination,\n\n    // Handlers\n    handleToggleSource,\n    handleSelectAll: () =>\n      dispatch({\n        type: \"setSelectedSources\",\n        payload: availableAssets,\n      }),\n    handleDeselectAll: () =>\n      dispatch({ type: \"setSelectedSources\", payload: [] }),\n    handleSourcesContinue,\n    handleAmountContinue,\n    handleConfirmOrder,\n    handleBack,\n    reset,\n  };\n};\n\nexport default useSwapDeposit;\n",
      "type": "registry:component",
      "target": "components/swap-deposit/hooks/useSwapDeposit.ts"
    }
  ]
}
